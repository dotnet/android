<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask AssemblyFile="$(MSBuildThisFileDirectory)..\..\bin\Build$(Configuration)\xa-prep-tasks.dll"  TaskName="Xamarin.Android.BuildTools.PrepTasks.GitCommitTime" />
  <Target Name="Build" DependsOnTargets="$(BuildDependsOn)" />
  <PropertyGroup>
    <_SourceTopDir>..\..</_SourceTopDir>
    <_BclFrameworkDir>$(XAInstallPrefix)xbuild-frameworks\MonoAndroid\v1.0\</_BclFrameworkDir>
    <_MSBuildDir>$(XAInstallPrefix)xbuild\Xamarin\Android</_MSBuildDir>
    <_OutputIncludeDir>..\..\bin\$(Configuration)\include\</_OutputIncludeDir>
    <_DebugFileExt Condition=" '$(_DebugFileExt)' == '' ">.pdb</_DebugFileExt>
  </PropertyGroup>
  <ItemGroup>
    <MonoDocCopyItem Include="monodoc.dll" />
    <MonoDocCopyItem
        Condition=" '$(_DebugFileExt)' == '.pdb'"
        Include="mdoc.pdb;monodoc.pdb"
    />
    <MonoDocCopyItem
        Condition=" '$(_DebugFileExt)' == '.mdb'"
        Include="mdoc.exe.mdb;monodoc.dll.mdb"
    />
    <MonoDocCopyItem Include="monodoc.dll.config" />
  </ItemGroup>
  <UsingTask AssemblyFile="$(_SourceTopDir)\bin\Build$(Configuration)\Xamarin.Android.Tools.BootstrapTasks.dll" TaskName="Xamarin.Android.Tools.BootstrapTasks.GetNugetPackageBasePath" />
  <ItemGroup>
    <_MonoDocCopyItems Include="@(MonoDocCopyItem->'$(_MonoOutputDir)\%(Identity)')" />
  </ItemGroup>
  <ItemGroup>
    <_MonoDocInstalledItems Include="@(MonoDocCopyItem->'$(_MSBuildDir)\%(Identity)')" />
    <_MonoDocInstalledItems Include="$(_MSBuildDir)\mdoc.exe" />
  </ItemGroup>
  <PropertyGroup>
    <_MonoProfileDir>$(MonoSourceFullPath)\mcs\class\lib\monodroid</_MonoProfileDir>
    <_MonoOutputDir>$(MonoSourceFullPath)\mcs\class\lib\monodroid_tools</_MonoOutputDir>
  </PropertyGroup>
  <PropertyGroup>
    <_MonoSdksConfiguration Condition=" '$(Configuration)' == 'Release' ">release</_MonoSdksConfiguration>
    <_MonoSdksConfiguration Condition=" '$(Configuration)' != 'Release' ">debug</_MonoSdksConfiguration>
  </PropertyGroup>
  <PropertyGroup>
    <ForceBuildDependsOn>
      _BuildLlvm;
      _InstallLlvm;
      _Autogen;
      _BuildRuntimes;
      _InstallRuntimes;
      _InstallBcl;
      _InstallCilStrip;
      _InstallMonoDoc;
      _InstallMonoUtilities;
      _ConfigureCrossRuntimes;
      _BuildCrossRuntimes;
      _InstallCrossRuntimes;
    </ForceBuildDependsOn>
  </PropertyGroup>
  <Import Project="mono-runtimes.props" />
  <Import Project="mono-runtimes.projitems" />
  <Import Project="ProfileAssemblies.projitems" />
  <ItemGroup>
    <_BclAssembly Include="@(MonoProfileAssembly)" />
    <_BclExcludeDebugSymbols  Include="System.Windows.dll" />
    <_BclExcludeDebugSymbols  Include="System.Xml.Serialization.dll" />
    <_BclTestAssemblyDestination  Include="@(MonoTestAssembly->'$(XAInstallPrefix)\..\..\bcl-tests\%(Identity)')" />
    <_BclTestAssemblyDestination
        Include="@(MonoTestAssembly->'$(XAInstallPrefix)\..\..\bcl-tests\%(Filename).pdb')"
        Exclude="$(XAInstallPrefix)\..\..\bcl-tests\System.Runtime.CompilerServices.Unsafe.pdb"
    />
    <_BclTestAssemblyDestination  Include="@(MonoTestRunner->'$(XAInstallPrefix)\..\..\bcl-tests\%(Identity)')" />
    <_BclTestAssemblyDestination  Include="@(MonoTestRunner->'$(XAInstallPrefix)\..\..\bcl-tests\%(Filename).pdb')" />
  </ItemGroup>
  <ItemGroup>
    <_BclTestOutput Include="@(_BclTestAssemblyDestination)" />
    <_BclTestOutput Include="$(XAInstallPrefix)\..\..\bcl-tests\bcl-tests.zip" />
  </ItemGroup>
  <ItemGroup>
    <_BclProfileItems Include="@(_BclAssembly->'$(_MonoProfileDir)\%(Identity)')" />
    <_BclProfileItems
        Condition=" '$(_DebugFileExt)' == '.mdb' "
        Include="@(_BclAssembly->'$(_MonoProfileDir)\%(Identity).mdb')"
        Exclude="@(_BclExcludeDebugSymbols->'$(_MonoProfileDir)\%(Identity).mdb')"
    />
    <_BclProfileItems
        Condition=" '$(_DebugFileExt)' == '.pdb' "
        Include="@(_BclAssembly->'$(_MonoProfileDir)\%(Filename).pdb')"
        Exclude="@(_BclExcludeDebugSymbols->'$(_MonoProfileDir)\%(Filename).pdb')"
    />
  </ItemGroup>
  <ItemGroup>
    <_BclInstalledItem Include="@(_BclAssembly->'$(_BclFrameworkDir)%(Identity)')" />
    <_BclInstalledItem
        Condition=" '$(_DebugFileExt)' == '.mdb' "
        Include="@(_BclAssembly->'$(_BclFrameworkDir)%(Identity).mdb')"
        Exclude="@(_BclExcludeDebugSymbols->'$(_BclFrameworkDir)%(Identity).mdb')"
    />
    <_BclInstalledItem
        Condition=" '$(_DebugFileExt)' == '.pdb' "
        Include="@(_BclAssembly->'$(_BclFrameworkDir)%(Filename).pdb')"
        Exclude="@(_BclExcludeDebugSymbols->'$(_BclFrameworkDir)%(Filename).pdb')"
    />
  </ItemGroup>
  <ItemGroup>
    <_MonoUtility  Include="illinkanalyzer.exe" />
    <_MonoUtility  Include="mono-symbolicate.exe" />
    <_MonoUtility  Include="mkbundle.exe" />
  </ItemGroup>
  <ItemGroup>
    <_MonoUtilitySource Include="@(_MonoUtility->'$(_MonoOutputDir)\%(Identity)')" />
    <_MonoUtilityDest   Include="@(_MonoUtility->'$(_MSBuildDir)\%(Identity)')" />
    <_MonoUtilitySource
        Condition=" '$(_DebugFileExt)' == '.mdb'"
        Include="@(_MonoUtility->'$(_MonoOutputDir)\%(Identity).mdb')"
    />
    <_MonoUtilityDest
        Condition=" '$(_DebugFileExt)' == '.mdb'"
        Include="@(_MonoUtility->'$(_MSBuildDir)\%(Identity).mdb')"
    />
    <_MonoUtilitySource
        Condition=" '$(_DebugFileExt)' == '.pdb'"
        Include="@(_MonoUtility->'$(_MonoOutputDir)\%(Filename).pdb')"
    />
    <_MonoUtilityDest
        Condition=" '$(_DebugFileExt)' == '.pdb'"
        Include="@(_MonoUtility->'$(_MSBuildDir)\%(Filename).pdb')"
    />
  </ItemGroup>
  <Target Name="_SetAutogenShTimeToLastCommitTimestamp">
    <GitCommitTime
        WorkingDirectory="$(MonoSourceFullPath)"
        ToolPath="$(GitToolPath)"
        ToolExe="$(GitToolExe)">
      <Output TaskParameter="Time" PropertyName="_MonoCommitTime" />
    </GitCommitTime>
    <Touch Files="$(MonoSourceFullPath)\autogen.sh" Time="$(_MonoCommitTime)" />
    <GitCommitTime
        WorkingDirectory="$(LlvmSourceFullPath)"
        ToolPath="$(GitToolPath)"
        ToolExe="$(GitToolExe)">
      <Output TaskParameter="Time" PropertyName="_LlvmCommitTime" />
    </GitCommitTime>
    <Touch Files="$(LlvmSourceFullPath)\Makefile.config.in" Time="$(_LlvmCommitTime)" />
  </Target>

  <Target Name="_PrepareLlvmItems">
    <ItemGroup>
      <_LlvmSourceFileWithoutMonoSdks Include="$(LlvmSourceFullPath)\lib\**\*.cpp" />
      <_LlvmHeaderFileWithoutMonoSdks Include="$(LlvmSourceFullPath)\lib\**\*.h" />
      <_LlvmMakefileConfigWithoutMonoSdks Include="@(_LlvmRuntime->'$(_LlvmOutputDirTop)\%(BuildDir)\Makefile.config')" Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' " />
      <_LlvmConfigureStampWithoutMonoSdks Include="@(_LlvmRuntime->'$(_LlvmOutputDirTop)\%(BuildDir)\.stamp-configure')" Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' " />
    </ItemGroup>

    <ItemGroup>
      <_LlvmArchiveWithoutMonoSdks Include="$(_LlvmOutputDirTop)\%(_LlvmRuntime.BuildDir)\Release\lib\*.a" Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' " />

      <_LlvmSourceBinaryWithoutMonoSdks Include="@(_LlvmRuntime->'$(_LlvmOutputDirTop)\%(BuildDir)\Release\bin\opt%(ExeSuffix)')" Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' And '%(_LlvmRuntime.InstallBinaries)' == 'true' " />
      <_LlvmTargetBinaryWithoutMonoSdks Include="@(_LlvmRuntime->'$(_MSBuildDir)\%(InstallPath)opt%(ExeSuffix)')" Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' And '%(_LlvmRuntime.InstallBinaries)' == 'true' " />

      <_LlvmSourceBinaryWithoutMonoSdks Include="@(_LlvmRuntime->'$(_LlvmOutputDirTop)\%(BuildDir)\Release\bin\llc%(ExeSuffix)')" Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' And '%(_LlvmRuntime.InstallBinaries)' == 'true' " />
      <_LlvmTargetBinaryWithoutMonoSdks Include="@(_LlvmRuntime->'$(_MSBuildDir)\%(InstallPath)llc%(ExeSuffix)')" Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' And '%(_LlvmRuntime.InstallBinaries)' == 'true' " />
    </ItemGroup>

    <ItemGroup>
      <_LlvmSourceBinary Include="@(_LlvmRuntime->'$(MonoSourceFullPath)\sdks\out\llvm-%(Identity)\bin\opt%(ExeSuffix)')" Condition=" '%(_LlvmRuntime.UseMonoSdks)' != 'False' And '%(_LlvmRuntime.InstallBinaries)' == 'true' " />
      <_LlvmTargetBinary Include="@(_LlvmRuntime->'$(_MSBuildDir)\%(InstallPath)opt%(ExeSuffix)')" Condition=" '%(_LlvmRuntime.UseMonoSdks)' != 'False' And '%(_LlvmRuntime.InstallBinaries)' == 'true' " />

      <_LlvmSourceBinary Include="@(_LlvmRuntime->'$(MonoSourceFullPath)\sdks\out\llvm-%(Identity)\bin\llc%(ExeSuffix)')" Condition=" '%(_LlvmRuntime.UseMonoSdks)' != 'False' And '%(_LlvmRuntime.InstallBinaries)' == 'true' " />
      <_LlvmTargetBinary Include="@(_LlvmRuntime->'$(_MSBuildDir)\%(InstallPath)llc%(ExeSuffix)')" Condition=" '%(_LlvmRuntime.UseMonoSdks)' != 'False' And '%(_LlvmRuntime.InstallBinaries)' == 'true' " />
    </ItemGroup>
  </Target>

  <Target Name="_ConfigureLlvmWithoutMonoSdks"
          DependsOnTargets="_PrepareLlvmItems"
          Inputs="$(LlvmSourceFullPath)\Makefile.config.in;$(LlvmSourceFullPath)\configure;@(_LlvmSourceFileWithoutMonoSdks);@(_LlvmHeaderFileWithoutMonoSdks)"
          Outputs="@(_LlvmMakefileConfigWithoutMonoSdks);@(_LlvmConfigureStampWithoutMonoSdks)"
          Condition=" '$(_LlvmNeeded)' != '' " >
    <MakeDir
        Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' "
        Directories="$(_LlvmOutputDirTop)\%(_LlvmRuntime.BuildDir)"
    />
    <Exec
        Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' "
        Command="%(_LlvmRuntime.ConfigureEnvironment) $(LlvmSourceFullPath)\configure %(_LlvmRuntime.ConfigureFlags)"
        IgnoreStandardErrorWarningFormat="True"
        WorkingDirectory="$(_LlvmOutputDirTop)\%(_LlvmRuntime.BuildDir)"
    />
    <Touch
        Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' "
        Files="$(_LlvmOutputDirTop)\%(_LlvmRuntime.BuildDir)\Makefile.config"
    />
    <Touch
        Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' "
        Files="$(_LlvmOutputDirTop)\%(_LlvmRuntime.BuildDir)\.stamp-configure"
        AlwaysCreate="true"
    />
  </Target>
  
  <Target Name="_BuildLlvm"
          DependsOnTargets="_BuildLlvmWithoutMonoSdks"
          Outputs="@(_LlvmSourceBinary)"
          Condition=" '$(_LlvmNeeded)' != '' ">
    <Exec
        Condition=" '%(_LlvmRuntime.UseMonoSdks)' != 'False' "
        Command="make $(MakeConcurrency) package-llvm-%(_LlvmRuntime.Identity) CONFIGURATION=$(_MonoSdksConfiguration)"
        IgnoreStandardErrorWarningFormat="True"
        WorkingDirectory="$(MonoSourceFullPath)\sdks\builds"
    />
  </Target>
  <Target Name="_BuildLlvmWithoutMonoSdks"
          DependsOnTargets="_ConfigureLlvmWithoutMonoSdks"
          Inputs="@(_LlvmConfigureStampWithoutMonoSdks);@(_LlvmSourceFileWithoutMonoSdks);@(_LlvmHeaderFileWithoutMonoSdks)"
          Outputs="@(_LlvmArchiveWithoutMonoSdks);@(_LlvmSourceBinaryWithoutMonoSdks)"
          Condition=" '$(_LlvmNeeded)' != '' ">
    <Exec
        Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' "
        Command="%(_LlvmRuntime.BuildEnvironment) make $(MakeConcurrency) all install"
        IgnoreStandardErrorWarningFormat="True"
        WorkingDirectory="$(_LlvmOutputDirTop)\%(_LlvmRuntime.BuildDir)"
    />
    <Touch
        Condition=" '%(_LlvmRuntime.UseMonoSdks)' == 'False' "
        Files="@(_LlvmArchiveWithoutMonoSdks);@(_LlvmSourceBinaryWithoutMonoSdks)"
    />
  </Target>

  <Target Name="_InstallLlvm"
          DependsOnTargets="_BuildLlvm"
          Inputs="@(_LlvmSourceBinaryWithoutMonoSdks);@(_LlvmSourceBinary)"
          Outputs="@(_LlvmTargetBinaryWithoutMonoSdks);@(_LlvmTargetBinary)"
          Condition=" '$(_LlvmNeeded)' != '' ">
    <Copy
        SourceFiles="@(_LlvmSourceBinaryWithoutMonoSdks)"
        DestinationFiles="@(_LlvmTargetBinaryWithoutMonoSdks)" />
    <Copy
        SourceFiles="@(_LlvmSourceBinary)"
        DestinationFiles="@(_LlvmTargetBinary)" />
    <Touch
        Files="@(_LlvmTargetBinaryWithoutMonoSdks);@(_LlvmTargetBinary)" />
  </Target>

  <Target Name="_Autogen"
      DependsOnTargets="_SetAutogenShTimeToLastCommitTimestamp"
      Inputs="$(MonoSourceFullPath)\autogen.sh"
      Outputs="$(MonoSourceFullPath)\configure">
    <Exec
        Command="make configure-mono"
        WorkingDirectory="$(MonoSourceFullPath)\sdks\builds"
    />
  </Target>

  <Target Name="_ConfigureRuntimesWithoutMonoSdks"
      DependsOnTargets="_BuildLlvm;_Autogen"
      Inputs="$(MonoSourceFullPath)\configure"
      Outputs="$(IntermediateOutputPath)\%(_MonoRuntime.Identity)\Makefile">
    <MakeDir
        Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' "
        Directories="$(IntermediateOutputPath)\%(_MonoRuntime.Identity)"
    />
    <Exec
        Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' "
        Command="$(MonoSourceFullPath)\configure LDFLAGS=&quot;%(_MonoRuntime.LdFlags)&quot; CFLAGS=&quot;%(_MonoRuntime.CFlags)&quot; CXXFLAGS=&quot;%(_MonoRuntime.CxxFlags)&quot; CC=&quot;%(_MonoRuntime.Cc)&quot; CXX=&quot;%(_MonoRuntime.Cxx)&quot; CPP=&quot;%(_MonoRuntime.Cpp)&quot; CXXCPP=&quot;%(_MonoRuntime.CxxCpp)&quot; LD=&quot;%(_MonoRuntime.Ld)&quot; AR=&quot;%(_MonoRuntime.Ar)&quot; AS=&quot;%(_MonoRuntime.As)&quot; RANLIB=&quot;%(_MonoRuntime.RanLib)&quot; STRIP=&quot;%(_MonoRuntime.Strip)&quot; DLLTOOL=&quot;%(_MonoRuntime.DllTool)&quot; OBJDUMP=&quot;%(_MonoRuntime.Objdump)&quot; --cache-file=..\%(_MonoRuntime.Identity).config.cache %(_MonoRuntime.ConfigureFlags)"
        IgnoreStandardErrorWarningFormat="True"
        WorkingDirectory="$(IntermediateOutputPath)\%(_MonoRuntime.Identity)"
    />
    <Touch
        Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' "
        Files="$(IntermediateOutputPath)\%(_MonoRuntime.Identity)\.stamp"
        AlwaysCreate="True"
    />
  </Target>

  <Target Name="_GetRuntimesOutputItems">
    <ItemGroup>
      <_RuntimeSource
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' "
          Include="@(_MonoRuntime->'$(MonoSourceFullPath)\sdks\out\android-%(Identity)-$(_MonoSdksConfiguration)\lib\%(OutputRuntimeFilename).%(NativeLibraryExtension)')"
      />
      <_RuntimeSourceWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' "
          Include="@(_MonoRuntime->'$(IntermediateOutputPath)\%(Identity)\mono\mini\.libs\%(OutputRuntimeFilename).%(NativeLibraryExtension)')"
      />
      <_MonoBinarySource
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And 'host-$(HostOS)' == '%(Identity)' "
          Include="@(_MonoRuntime->'$(MonoSourceFullPath)\sdks\out\android-%(Identity)-$(_MonoSdksConfiguration)\bin\mono')"
      />
      <_MonoBinarySourceWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And 'host-$(HostOS)' == '%(Identity)' "
          Include="@(_MonoRuntime->'$(IntermediateOutputPath)\%(Identity)\mono\mini\mono')"
      />
      <_InstallMonoBinaryOutput
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And 'host-$(HostOS)' == '%(Identity)' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\$(HostOS)\mono')"
      />
      <_InstallMonoBinaryOutputWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And 'host-$(HostOS)' == '%(Identity)' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\$(HostOS)\mono')"
      />
      <_InstallRuntimeOutput
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputRuntimeFilename).%(NativeLibraryExtension)')"
      />
      <_InstallRuntimeOutputWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputRuntimeFilename).%(NativeLibraryExtension)')"
      />
      <_InstallUnstrippedRuntimeOutput
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputRuntimeFilename).d.%(NativeLibraryExtension)')"
      />
      <_InstallUnstrippedRuntimeOutputWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputRuntimeFilename).d.%(NativeLibraryExtension)')"
      />
      <_ProfilerSource
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputProfilerFilename)' != '' "
          Include="@(_MonoRuntime->'$(MonoSourceFullPath)\sdks\out\android-%(Identity)-$(_MonoSdksConfiguration)\lib\%(OutputProfilerFilename).%(NativeLibraryExtension)')"
      />
      <_ProfilerSourceWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputProfilerFilename)' != '' "
          Include="@(_MonoRuntime->'$(IntermediateOutputPath)\%(Identity)\mono\profiler\.libs\%(OutputProfilerFilename).%(NativeLibraryExtension)')"
      />
      <_ProfilerSource
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputAotProfilerFilename)' != '' "
          Include="@(_MonoRuntime->'$(MonoSourceFullPath)\sdks\out\android-%(Identity)-$(_MonoSdksConfiguration)\lib\%(OutputAotProfilerFilename).%(NativeLibraryExtension)')"
      />
      <_ProfilerSourceWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputAotProfilerFilename)' != '' "
          Include="@(_MonoRuntime->'$(IntermediateOutputPath)\%(Identity)\mono\profiler\.libs\%(OutputAotProfilerFilename).%(NativeLibraryExtension)')"
      />
      <_InstallProfilerOutput
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputProfilerFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputProfilerFilename).%(NativeLibraryExtension)')"
      />
      <_InstallProfilerOutputWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputProfilerFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputProfilerFilename).%(NativeLibraryExtension)')"
      />
      <_InstallProfilerOutput
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputAotProfilerFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputAotProfilerFilename).%(NativeLibraryExtension)')"
      />
      <_InstallProfilerOutputWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputAotProfilerFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputAotProfilerFilename).%(NativeLibraryExtension)')"
      />
      <_InstallUnstrippedProfilerOutput
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputProfilerFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputProfilerFilename).d.%(NativeLibraryExtension)')"
      />
      <_InstallUnstrippedProfilerOutputWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputProfilerFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputProfilerFilename).d.%(NativeLibraryExtension)')"
      />
      <_InstallUnstrippedProfilerOutput
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputAotProfilerFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputAotProfilerFilename).d.%(NativeLibraryExtension)')"
      />
      <_InstallUnstrippedProfilerOutputWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputAotProfilerFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputAotProfilerFilename).d.%(NativeLibraryExtension)')"
      />
      <_MonoBtlsSource
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputMonoBtlsFilename)' != '' "
          Include="@(_MonoRuntime->'$(MonoSourceFullPath)\sdks\out\android-%(Identity)-$(_MonoSdksConfiguration)\lib\%(OutputMonoBtlsFilename).%(NativeLibraryExtension)')"
      />
      <_MonoBtlsSourceWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputMonoBtlsFilename)' != '' "
          Include="@(_MonoRuntime->'$(IntermediateOutputPath)\%(Identity)\mono\btls\build-shared\%(OutputMonoBtlsFilename).%(NativeLibraryExtension)')"
      />
      <_InstallMonoBtlsOutput
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputMonoBtlsFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputMonoBtlsFilename).%(NativeLibraryExtension)')"
      />
      <_InstallMonoBtlsOutputWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputMonoBtlsFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputMonoBtlsFilename).%(NativeLibraryExtension)')"
      />
      <_InstallUnstrippedMonoBtlsOutput
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputMonoBtlsFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputMonoBtlsFilename).d.%(NativeLibraryExtension)')"
      />
      <_InstallUnstrippedMonoBtlsOutputWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputMonoBtlsFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputMonoBtlsFilename).d.%(NativeLibraryExtension)')"
      />
      <_MonoPosixHelperSource
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputMonoPosixHelperFilename)' != '' "
          Include="@(_MonoRuntime->'$(MonoSourceFullPath)\sdks\out\android-%(Identity)-$(_MonoSdksConfiguration)\lib\%(OutputMonoPosixHelperFilename).%(NativeLibraryExtension)')"
      />
      <_MonoPosixHelperSourceWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputMonoPosixHelperFilename)' != '' "
          Include="@(_MonoRuntime->'$(IntermediateOutputPath)\%(Identity)\support\.libs\%(OutputMonoPosixHelperFilename).%(NativeLibraryExtension)')"
      />
      <_InstallMonoPosixHelperOutput
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputMonoPosixHelperFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputMonoPosixHelperFilename).%(NativeLibraryExtension)')"
      />
      <_InstallMonoPosixHelperOutputWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputMonoPosixHelperFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputMonoPosixHelperFilename).%(NativeLibraryExtension)')"
      />
      <_InstallUnstrippedMonoPosixHelperOutput
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputMonoPosixHelperFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputMonoPosixHelperFilename).d.%(NativeLibraryExtension)')"
      />
      <_InstallUnstrippedMonoPosixHelperOutputWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' And '%(_MonoRuntime.OutputMonoPosixHelperFilename)' != '' "
          Include="@(_MonoRuntime->'$(_MSBuildDir)\lib\%(Identity)\%(OutputMonoPosixHelperFilename).d.%(NativeLibraryExtension)')"
      />
      <_RuntimeEglibHeaderSource
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' "
          Include="@(_MonoRuntime->'$(MonoSourceFullPath)\sdks\builds\android-%(Identity)-$(_MonoSdksConfiguration)\mono\eglib\eglib-config.h')"
      />
      <_RuntimeEglibHeaderSourceWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' "
          Include="@(_MonoRuntime->'$(IntermediateOutputPath)\%(Identity)\mono\eglib\eglib-config.h')"
      />
      <_RuntimeEglibHeaderOutput
          Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'True' "
          Include="@(_MonoRuntime->'$(_OutputIncludeDir)%(Identity)\eglib\eglib-config.h')"
      />
      <_RuntimeEglibHeaderOutputWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'True' "
          Include="@(_MonoRuntime->'$(_OutputIncludeDir)%(Identity)\eglib\eglib-config.h')"
      />
      <_MonoConstsSource
          Condition=" '%(_MonoRuntime.DoBuild)' == 'True' "
          Include="$(MonoSourceFullPath)\mcs\build\common\Consts.cs"
      />
      <_MonoConstsOutput
          Condition=" '%(_MonoRuntime.DoBuild)' == 'True' "
          Include="$(_OutputIncludeDir)Consts.cs"
      />
      <_RuntimeBuildStampWithoutMonoSdks
          Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'true' "
          Include="@(_MonoRuntime->'$(IntermediateOutputPath)\%(Identity)\.stamp')"
      />
    </ItemGroup>
  </Target>

  <Target Name="_BuildRuntimes"
      DependsOnTargets="_BuildRuntimesWithoutMonoSdks;_GetRuntimesOutputItems"
      Outputs="@(_RuntimeSource);@(_MonoBinarySource);@(_ProfilerSource);@(_MonoPosixHelperSource);@(_RuntimeEglibHeaderSource);@(_MonoBtlsSource);@(_BclTestOutput)">
    <Exec
        Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.DoBuild)' == 'true' "
        Command="make $(MakeConcurrency) package-android-%(_MonoRuntime.Identity) CONFIGURATION=$(_MonoSdksConfiguration) ANDROID_TOOLCHAIN_PREFIX=&quot;$(AndroidToolchainDirectory)\toolchains&quot;"
        IgnoreStandardErrorWarningFormat="True"
        WorkingDirectory="$(MonoSourceFullPath)\sdks\builds"
    />
    <Exec
        Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' And '%(_MonoRuntime.BuildTests)' == 'True' "
        Command="make $(MakeConcurrency) -C android-%(_MonoRuntime.Identity)-$(_MonoSdksConfiguration) -C runtime test"
        IgnoreStandardErrorWarningFormat="True"
        WorkingDirectory="$(MonoSourceFullPath)\sdks\builds"
    />
    <Exec
        Condition=" '%(MonoTestAssembly.TestType)' == 'xunit' "
        Command="make -C $(MonoSourceFullPath)\mcs\class\%(MonoTestAssembly.SourcePath) xunit-test-local"
        WorkingDirectory="$(MonoSourceFullPath)"
    />
  </Target>
  <Target Name="_BuildRuntimesWithoutMonoSdks"
      DependsOnTargets="_GetRuntimesOutputItems;_ConfigureRuntimesWithoutMonoSdks"
      Inputs="@(_RuntimeBuildStampWithoutMonoSdks)"
      Outputs="@(_RuntimeSourceWithoutMonoSdks);@(_MonoBinarySourceWithoutMonoSdks);@(_ProfilerSourceWithoutMonoSdks);@(_MonoPosixHelperSourceWithoutMonoSdks);@(_RuntimeEglibHeaderSourceWithoutMonoSdks);@(_MonoBtlsSourceWithoutMonoSdks)">
    <Exec
        Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' And '%(_MonoRuntime.DoBuild)' == 'true' "
        Command="make $(MakeConcurrency) # %(_MonoRuntime.Identity)"
        IgnoreStandardErrorWarningFormat="True"
        WorkingDirectory="$(IntermediateOutputPath)\%(_MonoRuntime.Identity)"
    />
    <Touch
        Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' "
        Files="@(_RuntimeSourceWithoutMonoSdks);@(_MonoBinarySourceWithoutMonoSdks);@(_ProfilerSourceWithoutMonoSdks);@(_MonoPosixHelperSourceWithoutMonoSdks);@(_RuntimeEglibHeaderSourceWithoutMonoSdks);@(_MonoBtlsSourceWithoutMonoSdks)"
    />
  </Target>

  <Target Name="_InstallRuntimes"
      DependsOnTargets="_GetRuntimesOutputItems"
      Inputs="@(_RuntimeSourceWithoutMonoSdks);@(_RuntimeSource);@(_MonoBinarySourceWithoutMonoSdks);@(_MonoBinarySource);@(_ProfilerSourceWithoutMonoSdks);@(_ProfilerSource);@(_MonoPosixHelperSourceWithoutMonoSdks);@(_MonoPosixHelperSource);@(_RuntimeEglibHeaderSourceWithoutMonoSdks);@(_RuntimeEglibHeaderSource);@(_MonoBtlsSourceWithoutMonoSdks);@(_MonoBtlsSource)"
      Outputs="@(_InstallRuntimeOutputWithoutMonoSdks);@(_InstallRuntimeOutput);@(_InstallMonoBinaryOutputWithoutMonoSdks);@(_InstallMonoBinaryOutput);@(_InstallProfilerOutputWithoutMonoSdks);@(_InstallProfilerOutput);@(_InstallMonoPosixHelperOutputWithoutMonoSdks);@(_InstallMonoPosixHelperOutput);@(_RuntimeEglibHeaderOutputWithoutMonoSdks);@(_RuntimeEglibHeaderOutput)">
    <ItemGroup>
      <_BclTestAssemblyReference Include="@(MonoTestAssembly)" Condition="'%(MonoTestAssembly.TestType)' == 'reference'" />
      <_BclTestAssemblyXUnit  Include="@(MonoTestAssembly)" Condition="'%(MonoTestAssembly.TestType)' == 'xunit'" />
      <_BclTestAssemblyNUnit  Include="@(MonoTestAssembly)" Condition="'%(MonoTestAssembly.TestType)' == ''" />
      <_BclTestAssemblySource Include="@(_BclTestAssemblyReference->'$(MonoSourceFullPath)\mcs\class\lib\monodroid\%(Identity)')" />
      <_BclTestAssemblySource Include="@(_BclTestAssemblyReference->'$(MonoSourceFullPath)\mcs\class\lib\monodroid\%(Filename).pdb')" Condition="Exists('@(_BclTestAssemblyReference->'$(MonoSourceFullPath)\mcs\class\lib\monodroid\%(Filename).pdb')')" />
      <_BclTestAssemblySource Include="@(_BclTestAssemblyXUnit->'$(MonoSourceFullPath)\mcs\class\%(SourcePath)\%(Identity)')" />
      <_BclTestAssemblySource Include="@(_BclTestAssemblyXUnit->'$(MonoSourceFullPath)\mcs\class\%(SourcePath)\%(Filename).pdb')" />
      <_BclTestAssemblySource Include="@(_BclTestAssemblyNUnit->'$(MonoSourceFullPath)\mcs\class\lib\monodroid\tests\%(Identity)')" />
      <_BclTestAssemblySource Include="@(_BclTestAssemblyNUnit->'$(MonoSourceFullPath)\mcs\class\lib\monodroid\tests\%(Filename).pdb')" />
      <_BclTestAssemblySource Include="@(MonoTestRunner->'$(MonoSourceFullPath)\mcs\class\lib\monodroid\%(Identity)')" />
      <_BclTestAssemblySource Include="@(MonoTestRunner->'$(MonoSourceFullPath)\mcs\class\lib\monodroid\%(Filename).pdb')" />
    </ItemGroup>
    <Copy
        SourceFiles="@(_BclTestAssemblySource)"
        DestinationFolder="$(XAInstallPrefix)\..\..\bcl-tests"
    />
    <Touch
        Files="@(_BclTestAssemblySource->'$(XAInstallPrefix)\..\..\bcl-tests\%(Filename)%(Extension)')"
    />
    <ItemGroup>
      <_BclTestContent      Include="$(MonoSourceFullPath)\mcs\class\%(MonoTestAssembly.SourcePath)\Test\**\*.*" />
      <_BclTestContent      Remove="$(MonoSourceFullPath)\mcs\class\%(MonoTestAssembly.SourcePath)\Test\**\*.cs" />
      <_BclTestContent      Remove="$(MonoSourceFullPath)\mcs\class\%(MonoTestAssembly.SourcePath)\Test\**\.gitattributes" />
      <_BclTestContentDest  Include="@(_BclTestContent->'$(XAInstallPrefix)\..\..\bcl-tests\Test\%(RecursiveDir)%(Filename)%(Extension)')" />
    </ItemGroup>
    <ItemGroup>
      <_BclTestContent      Include="$(MonoSourceFullPath)\mcs\class\System.IO.Compression\test.nupkg" />
      <_BclTestContentDest  Include="$(XAInstallPrefix)\..\..\bcl-tests\test.nupkg" />
      <_BclTestContent      Include="$(MonoSourceFullPath)\mcs\class\System.IO.Compression\archive.zip" />
      <_BclTestContentDest  Include="$(XAInstallPrefix)\..\..\bcl-tests\archive.zip" />
    </ItemGroup>
    <ItemGroup>
      <_ZipTestContent      Include="$(MonoSourceFullPath)\mcs\class\System.IO.Compression.FileSystem\foo\**\*.*" />
      <_ZipTestContentDest  Include="@(_ZipTestContent->'$(XAInstallPrefix)\..\..\bcl-tests\foo\%(RecursiveDir)%(Filename)%(Extension)')" />
      <_BclTestContent      Include="@(_ZipTestContent)" />
      <_BclTestContentDest  Include="@(_ZipTestContentDest)" />
    </ItemGroup>
    <Copy
        SourceFiles="@(_BclTestContent)"
        DestinationFiles="@(_BclTestContentDest)"
    />
    <Exec
        Condition="!Exists('$(XAInstallPrefix)\..\..\bcl-tests\Test\test.db')"
        Command="sqlite3 &quot;$(XAInstallPrefix)\..\..\bcl-tests\Test\test.db&quot; &lt; &quot;$(MonoSourceFullPath)\mcs\class\Mono.Data.Sqlite\Test\test.sql&quot;"
    />
    <Exec
        Command="zip -r bcl-tests.zip ."
        WorkingDirectory="$(XAInstallPrefix)\..\..\bcl-tests"
    />
    <Touch
        Files="$(XAInstallPrefix)\..\..\bcl-tests\bcl-tests.zip"
    />

    <MakeDir
        Condition=" '%(_MonoRuntime.DoBuild)' == 'true' "
        Directories="$(_MSBuildDir)\lib\%(_MonoRuntime.Identity)"
    />
    <MakeDir
        Condition=" '%(_MonoRuntime.DoBuild)' == 'true'  And 'host-$(HostOS)' == '%(_MonoRuntime.Identity)' "
        Directories="$(_MSBuildDir)\$(HostOS)"
    />
    <MakeDir
        Condition=" '%(_MonoRuntime.DoBuild)' == 'true' "
        Directories="$(_OutputIncludeDir)%(_MonoRuntime.Identity)\eglib"
    />
    <Copy
        SourceFiles="@(_RuntimeEglibHeaderSourceWithoutMonoSdks)"
        DestinationFiles="@(_RuntimeEglibHeaderOutputWithoutMonoSdks)"
    />
    <Copy
        SourceFiles="@(_RuntimeEglibHeaderSource)"
        DestinationFiles="@(_RuntimeEglibHeaderOutput)"
    />
    <Touch Files="@(_RuntimeEglibHeaderOutputWithoutMonoSdks);@(_RuntimeEglibHeaderOutput)" />

    <Copy
        SourceFiles="@(_MonoConstsSource)"
        DestinationFiles="@(_MonoConstsOutput)"
    />
    <Touch Files="@(_MonoConstsOutput)" />

    <Copy
        SourceFiles="@(_RuntimeSourceWithoutMonoSdks)"
        DestinationFiles="@(_InstallRuntimeOutputWithoutMonoSdks)"
    />
    <Copy
        SourceFiles="@(_RuntimeSource)"
        DestinationFiles="@(_InstallRuntimeOutput)"
    />
    <Copy
        SourceFiles="@(_MonoBinarySourceWithoutMonoSdks)"
        DestinationFiles="@(_InstallMonoBinaryOutputWithoutMonoSdks)"
    />
    <Copy
        SourceFiles="@(_MonoBinarySource)"
        DestinationFiles="@(_InstallMonoBinaryOutput)"
    />
    <Copy
        SourceFiles="@(_RuntimeSourceWithoutMonoSdks)"
        DestinationFiles="@(_InstallUnstrippedRuntimeOutputWithoutMonoSdks)"
    />
    <Copy
        SourceFiles="@(_RuntimeSource)"
        DestinationFiles="@(_InstallUnstrippedRuntimeOutput)"
    />
    <Exec
        Condition=" ('$(Configuration)' != 'Debug' Or '%(_MonoRuntime.NativeLibraryExtension)' == 'dll') And '%(_MonoRuntime.DoBuild)' == 'true' "
        Command="&quot;%(_MonoRuntime.Strip)&quot; %(_MonoRuntime.StripFlags) &quot;$(_MSBuildDir)\lib\%(_MonoRuntime.Identity)\%(_MonoRuntime.OutputRuntimeFilename).%(_MonoRuntime.NativeLibraryExtension)&quot;"
    />
    <Touch Files="@(_InstallRuntimeOutputWithoutMonoSdks);@(_InstallRuntimeOutput);@(_InstallUnstrippedRuntimeOutputWithoutMonoSdks);@(_InstallUnstrippedRuntimeOutput)" />

    <Copy
        SourceFiles="@(_ProfilerSourceWithoutMonoSdks)"
        DestinationFiles="@(_InstallProfilerOutputWithoutMonoSdks)"
    />
    <Copy
        SourceFiles="@(_ProfilerSourceWithoutMonoSdks)"
        DestinationFiles="@(_InstallUnstrippedProfilerOutputWithoutMonoSdks)"
    />
    <Copy
        SourceFiles="@(_ProfilerSource)"
        DestinationFiles="@(_InstallProfilerOutput)"
    />
    <Copy
        SourceFiles="@(_ProfilerSource)"
        DestinationFiles="@(_InstallUnstrippedProfilerOutput)"
    />
    <Exec
        Condition=" '$(Configuration)' != 'Debug' And '%(_MonoRuntime.DoBuild)' == 'true' And '%(_MonoRuntime.OutputProfilerFilename)' != '' "
        Command="&quot;%(_MonoRuntime.Strip)&quot; %(_MonoRuntime.StripFlags) &quot;$(_MSBuildDir)\lib\%(_MonoRuntime.Identity)\%(_MonoRuntime.OutputProfilerFilename).%(_MonoRuntime.NativeLibraryExtension)&quot;"
    />
    <Touch Files="@(_InstallProfilerOutputWithoutMonoSdks);@(_InstallProfilerOutput);@(_InstallUnstrippedProfilerOutputWithoutMonoSdks);@(_InstallUnstrippedProfilerOutput)" />

    <Copy
        SourceFiles="@(_MonoBtlsSourceWithoutMonoSdks)"
        DestinationFiles="@(_InstallMonoBtlsOutputWithoutMonoSdks)"
    />
    <Copy
        SourceFiles="@(_MonoBtlsSourceWithoutMonoSdks)"
        DestinationFiles="@(_InstallUnstrippedMonoBtlsOutputWithoutMonoSdks)"
    />
    <Copy
        SourceFiles="@(_MonoBtlsSource)"
        DestinationFiles="@(_InstallMonoBtlsOutput)"
    />
    <Copy
        SourceFiles="@(_MonoBtlsSource)"
        DestinationFiles="@(_InstallUnstrippedMonoBtlsOutput)"
    />
    <Exec
        Condition=" '$(Configuration)' != 'Debug' And '%(_MonoRuntime.DoBuild)' == 'true' And '%(_MonoRuntime.OutputMonoBtlsFilename)' != '' "
        Command="&quot;%(_MonoRuntime.Strip)&quot; %(_MonoRuntime.StripFlags) &quot;$(_MSBuildDir)\lib\%(_MonoRuntime.Identity)\%(_MonoRuntime.OutputMonoBtlsFilename).%(_MonoRuntime.NativeLibraryExtension)&quot;"
    />
    <Touch Files="@(_InstallMonoBtlsOutput);@(_InstallUnstrippedMonoBtlsOutput)" />

    <Copy
        SourceFiles="@(_MonoPosixHelperSourceWithoutMonoSdks)"
        DestinationFiles="@(_InstallMonoPosixHelperOutputWithoutMonoSdks)"
    />
    <Copy
        SourceFiles="@(_MonoPosixHelperSourceWithoutMonoSdks)"
        DestinationFiles="@(_InstallUnstrippedMonoPosixHelperOutputWithoutMonoSdks)"
    />
    <Copy
        SourceFiles="@(_MonoPosixHelperSource)"
        DestinationFiles="@(_InstallMonoPosixHelperOutput)"
    />
    <Copy
        SourceFiles="@(_MonoPosixHelperSource)"
        DestinationFiles="@(_InstallUnstrippedMonoPosixHelperOutput)"
    />
    <Exec
        Condition=" '$(Configuration)' != 'Debug' And '%(_MonoRuntime.DoBuild)' == 'true' And '%(_MonoRuntime.OutputMonoPosixHelperFilename)' != '' "
        Command="&quot;%(_MonoRuntime.Strip)&quot; %(_MonoRuntime.StripFlags) &quot;$(_MSBuildDir)\lib\%(_MonoRuntime.Identity)\%(_MonoRuntime.OutputMonoPosixHelperFilename).%(_MonoRuntime.NativeLibraryExtension)&quot;"
    />
    <Touch Files="@(_InstallMonoPosixHelperOutputWithoutMonoSdks);@(_InstallMonoPosixHelperOutput);@(_InstallUnstrippedMonoPosixHelperOutputWithoutMonoSdks);@(_InstallUnstrippedMonoPosixHelperOutput)" />
  </Target>
  <ItemGroup>
    <_MonoCilStripSource  Include="$(_MonoOutputDir)\mono-cil-strip.exe" />
    <_MonoCilStripDest    Include="$(_MSBuildDir)\cil-strip.exe" />
    <_MonoCilStripSource
        Condition=" '$(_DebugFileExt)' == '.mdb' "
        Include="$(_MonoOutputDir)\mono-cil-strip.exe.mdb"
    />
    <_MonoCilStripDest
        Condition=" '$(_DebugFileExt)' == '.mdb' "
        Include="$(_MonoOutputDir)\cil-strip.exe.mdb"
    />
    <_MonoCilStripSource
        Condition=" '$(_DebugFileExt)' == '.pdb' "
        Include="$(_MonoOutputDir)\mono-cil-strip.pdb"
    />
    <_MonoCilStripDest
        Condition=" '$(_DebugFileExt)' == '.pdb' "
        Include="$(_MSBuildDir)\cil-strip.pdb"
    />
  </ItemGroup>
  <Target Name="_InstallCilStrip"
      Inputs="@(_MonoCilStripSource)"
      Outputs="@(_MonoCilStripDest)">
    <MakeDir Directories="$(_MSBuildDir)" />
    <Copy
        SourceFiles="@(_MonoCilStripSource)"
        DestinationFiles="@(_MonoCilStripDest)"
    />
  </Target>
  <Target Name="_InstallMonoDoc"
      Inputs="@(_MonoDocCopyItems);$(_MonoOutputDir)\mdoc.exe"
      Outputs="@(_MonoDocInstalledItems)">
    <MakeDir Directories="$(_MSBuildDir)" />
    <Copy
        SourceFiles="@(_MonoDocCopyItems)"
        DestinationFolder="$(_MSBuildDir)"
    />
    <Exec
        Command="$(RemapAssemblyRefTool) &quot;$(_MonoOutputDir)\mdoc.exe&quot; &quot;$(_MSBuildDir)\mdoc.exe&quot; Mono.Cecil &quot;..\..\bin\Build$(Configuration)\Xamarin.Android.Cecil.dll&quot;"
    />
    <Touch
        Files="@(_MonoDocInstalledItems)"
    />
  </Target>
  <Target Name="_InstallMonoUtilities"
      Inputs="@(_MonoUtilitySource)"
      Outputs="@(_MonoUtilityDest)">
    <MakeDir Directories="$(_MSBuildDir)" />
    <Copy
        SourceFiles="@(_MonoUtilitySource)"
        DestinationFiles="@(_MonoUtilityDest)"
    />
  </Target>
  <Target Name="_InstallBcl"
      Inputs="@(_BclProfileItems)"
      Outputs="@(_BclInstalledItem);$(_BclFrameworkDir)RedistList\FrameworkList.xml">
    <MakeDir Directories="$(_BclFrameworkDir)" />
    <MakeDir Directories="$(_BclFrameworkDir)RedistList" />
    <MakeDir Directories="$(_BclFrameworkDir)Facades" />
    <ItemGroup>
      <_PackageConfigFiles Include="$(_SourceTopDir)\src\Xamarin.Android.Build.Tasks\packages.config" />
    </ItemGroup>
    <ItemGroup>
      <_Facades Include="$(_MonoProfileDir)\Facades\*.dll" />
    </ItemGroup>
    <Copy
        SourceFiles="@(_BclProfileItems)"
        DestinationFiles="@(_BclInstalledItem)"
    />
    <Copy
        SourceFiles="@(_Facades)"
        DestinationFolder="$(_BclFrameworkDir)Facades"
    />
    <Touch
        Files="@(_BclInstalledItem)"
    />
    <ItemGroup>
      <FrameworkList Include="&lt;FileList Redist=&quot;MonoAndroid&quot; Name=&quot;Xamarin.Android Base Class Libraries&quot;&gt;" />
      <FrameworkList Include="&lt;/FileList&gt;" />
    </ItemGroup>
    <WriteLinesToFile
        File="$(_BclFrameworkDir)RedistList\FrameworkList.xml"
        Lines="@(FrameworkList)"
        Overwrite="True"
    />
  </Target>

  <!-- The condition below is to work around a bug in xbuild which attempts to batch
       even if there are no _MonoCrossRuntime items and the Copy task fails
  -->
  <Target Name="_ConfigureCrossRuntimes"
          DependsOnTargets="_BuildLlvm"
          Inputs="$(MonoSourceFullPath)\configure"
          Outputs="$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)\Makefile;$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)\.stamp"
          Condition=" '@(_MonoCrossRuntime)' != '' ">
    <Message Text="Configuring %(_MonoCrossRuntime.Identity) in $(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)"/>
    <MakeDir Directories="$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)" />
    <Exec
        Command="%(_MonoCrossRuntime.ConfigureEnvironment) $(MonoSourceFullPath)\configure LDFLAGS=&quot;%(_MonoCrossRuntime.LdFlags)&quot; CFLAGS=&quot;%(_MonoCrossRuntime.CFlags)&quot; CXXFLAGS=&quot;%(_MonoCrossRuntime.CxxFlags)&quot; CC=&quot;%(_MonoCrossRuntime.Cc)&quot; CXX=&quot;%(_MonoCrossRuntime.Cxx)&quot; CPP=&quot;%(_MonoCrossRuntime.Cpp)&quot; CXXCPP=&quot;%(_MonoCrossRuntime.CxxCpp)&quot; LD=&quot;%(_MonoCrossRuntime.Ld)&quot; AR=&quot;%(_MonoCrossRuntime.Ar)&quot; AS=&quot;%(_MonoCrossRuntime.As)&quot; RANLIB=&quot;%(_MonoCrossRuntime.RanLib)&quot; STRIP=&quot;%(_MonoCrossRuntime.Strip)&quot; DLLTOOL=&quot;%(_MonoCrossRuntime.DllTool)&quot; OBJDUMP=&quot;%(_MonoCrossRuntime.Objdump)&quot; --cache-file=..\%(_MonoCrossRuntime.Identity).config.cache %(_MonoCrossRuntime.ConfigureFlags)"
        IgnoreStandardErrorWarningFormat="True"
        WorkingDirectory="$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)"
    />
    <Touch
        Files="$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)\.stamp"
        AlwaysCreate="True"
    />
  </Target>
  
  <Target Name="_GenerateCrossOffsetHeaderFiles"
      Inputs="$(MonoSourceFullPath)\configure"
      Outputs="$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)\%(_MonoCrossRuntime.TargetAbi).h"
      Condition=" '@(_MonoCrossRuntime)' != '' ">
    <Exec
        Command="make $(_AotOffsetsDumperName)"
        WorkingDirectory="$(_AotOffsetsDumperSourceDir)" 
    />
    <PropertyGroup>
      <_CppAbiDir Condition="$(AndroidSupportedHostJitAbisForConditionalChecks.Contains (':Darwin:'))">osx_32</_CppAbiDir>
      <_CppAbiArch Condition="$(AndroidSupportedHostJitAbisForConditionalChecks.Contains (':Darwin:'))">--arch=32</_CppAbiArch>
      <_CppAbiDir Condition="$(AndroidSupportedHostJitAbisForConditionalChecks.Contains (':Linux:'))">linux_64</_CppAbiDir>
      <_CppAbiArch Condition="$(AndroidSupportedHostJitAbisForConditionalChecks.Contains (':Linux:'))"></_CppAbiArch>
    </PropertyGroup>
    <Exec
        Command="MONO_PATH=$(_AotOffsetsDumperSourceDir)\CppSharp\$(_CppAbiDir) $(ManagedRuntime) $(_CppAbiArch) $(_AotOffsetsDumperSourceDir)\$(_AotOffsetsDumperName) --android-ndk=&quot;$(AndroidNdkFullPath)&quot; --mono=&quot;$(MonoSourceFullPath)&quot; --monodroid=&quot;$(XamarinAndroidSourcePath)&quot; --abi=&quot;%(_MonoCrossRuntime.TargetAbi)&quot; --targetdir=&quot;$(MonoSourceFullPath)\sdks\builds\android-%(_MonoCrossRuntime.JitArch)-$(_MonoSdksConfiguration)&quot; --out=&quot;$(MSBuildThisFileDirectory)$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)&quot;"
        WorkingDirectory="$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)"
    />
    <Touch
        Files="$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)\%(_MonoCrossRuntime.TargetAbi).h"
    />
  </Target>

  <ItemGroup>
    <_MonoCrossRuntimeStamp               Include="$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)\.stamp" />
    <_MonoCrossRuntimeIntermediateOutput  Include="$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)\mono\mini\mono-sgen%(_MonoCrossRuntime.ExeSuffix)" />
    <_MonoCrossRuntimeOutput              Include="$(_MSBuildDir)\%(_MonoCrossRuntime.InstallPath)%(_MonoCrossRuntime.CrossMonoName)%(_MonoCrossRuntime.ExeSuffix)" />
  </ItemGroup>

  <!-- The condition below is to work around a bug in xbuild which attempts to batch
       even if there are no _MonoCrossRuntime items and the Copy task fails
  -->
  <Target Name="_BuildCrossRuntimes"
      DependsOnTargets="_GenerateCrossOffsetHeaderFiles"
      Inputs="@(_MonoCrossRuntimeStamp)"
      Outputs="@(_MonoCrossRuntimeIntermediateOutput)"
      Condition=" '@(_MonoCrossRuntime)' != '' ">
    <Message Text="Building %(_MonoCrossRuntime.Identity) in $(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)"/>
    <Exec
        Command="%(_MonoCrossRuntime.BuildEnvironment) make $(MakeConcurrency)"
        IgnoreStandardErrorWarningFormat="True"
        WorkingDirectory="$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)"
    />
    <Touch
        Files="@(_MonoCrossRuntimeIntermediateOutput)"
    />
  </Target>

  <!-- The condition below is to work around a bug in xbuild which attempts to batch
       even if there are no _MonoCrossRuntime items and the Copy task fails
  -->
  <Target Name="_InstallCrossRuntimes"
      Inputs="@(_MonoCrossRuntimeIntermediateOutput)"
      Outputs="@(_MonoCrossRuntimeOutput)"
      Condition=" '@(_MonoCrossRuntime)' != '' ">
    <Copy
        SourceFiles="$(IntermediateOutputPath)\%(_MonoCrossRuntime.Identity)\mono\mini\mono-sgen%(_MonoCrossRuntime.ExeSuffix)"
        DestinationFiles="$(_MSBuildDir)\%(_MonoCrossRuntime.InstallPath)%(_MonoCrossRuntime.CrossMonoName)%(_MonoCrossRuntime.ExeSuffix)"
    />
    <Copy
        SourceFiles="$(_MSBuildDir)\%(_MonoCrossRuntime.InstallPath)%(_MonoCrossRuntime.CrossMonoName)%(_MonoCrossRuntime.ExeSuffix)"
        DestinationFiles="$(_MSBuildDir)\%(_MonoCrossRuntime.InstallPath)%(_MonoCrossRuntime.CrossMonoName).d%(_MonoCrossRuntime.ExeSuffix)"
    />
    <Exec
        Condition=" '$(Configuration)' != 'Debug' Or '%(_MonoCrossRuntime.ExeSuffix)' == '.exe' "
        Command="&quot;%(_MonoCrossRuntime.Strip)&quot; %(_MonoCrossRuntime.StripFlags) &quot;$(_MSBuildDir)\%(_MonoCrossRuntime.InstallPath)%(_MonoCrossRuntime.CrossMonoName)%(_MonoCrossRuntime.ExeSuffix)&quot;"
    />
    <Touch
        Files="@(_MonoCrossRuntimeOutput)"
    />
  </Target>
  <Target Name="GetMonoBundleItems"
      DependsOnTargets="_GetRuntimesOutputItems;_PrepareLlvmItems">
    <ItemGroup>
      <BundleItem Include="@(_BclInstalledItem)" />
      <BundleItem Include="@(_MonoDocInstalledItems)" />
      <BundleItem Include="@(_MonoCilStripDest)" />
      <BundleItem Include="@(_MonoUtilityDest)" />
      <BundleItem Include="@(MonoFacadeAssembly->'$(_BclFrameworkDir)Facades\%(Identity)')" />
      <BundleItem Include="$(_BclFrameworkDir)RedistList\FrameworkList.xml" />
      <BundleItem Include="@(_InstallRuntimeOutputWithoutMonoSdks);@(_InstallRuntimeOutput)" />
      <BundleItem Include="@(_InstallMonoBinaryOutputWithoutMonoSdks);@(_InstallMonoBinaryOutput)" />
      <BundleItem Include="@(_InstallUnstrippedRuntimeOutputWithoutMonoSdks);@(_InstallUnstrippedRuntimeOutput)" />
      <BundleItem Include="@(_InstallProfilerOutputWithoutMonoSdks);@(_InstallProfilerOutput)" />
      <BundleItem Include="@(_InstallUnstrippedProfilerOutputWithoutMonoSdks);@(_InstallUnstrippedProfilerOutput)" />
      <BundleItem Include="@(_InstallMonoBtlsOutputWithoutMonoSdks);@(_InstallMonoBtlsOutput)" />
      <BundleItem Include="@(_InstallUnstrippedMonoBtlsOutputWithoutMonoSdks);@(_InstallUnstrippedMonoBtlsOutput)" />
      <BundleItem Include="@(_InstallMonoPosixHelperOutputWithoutMonoSdks);@(_InstallMonoPosixHelperOutput)" />
      <BundleItem Include="@(_InstallUnstrippedMonoPosixHelperOutputWithoutMonoSdks);@(_InstallUnstrippedMonoPosixHelperOutput)" />
      <BundleItem Include="@(_RuntimeEglibHeaderOutputWithoutMonoSdks);@(_RuntimeEglibHeaderOutput)" />
      <BundleItem Include="@(_MonoConstsOutput)" />
      <BundleItem Include="@(_LlvmTargetBinaryWithoutMonoSdks);@(_LlvmTargetBinary)" />
      <BundleItem Include="$(_MSBuildDir)\%(_MonoCrossRuntime.InstallPath)%(_MonoCrossRuntime.CrossMonoName).d%(_MonoCrossRuntime.ExeSuffix)"
          Condition=" '@(_MonoCrossRuntime)' != '' "
      />
      <BundleItem Include="$(_MSBuildDir)\%(_MonoCrossRuntime.InstallPath)%(_MonoCrossRuntime.CrossMonoName)%(_MonoCrossRuntime.ExeSuffix)"
          Condition=" '@(_MonoCrossRuntime)' != '' "
      />
      <BundleItem Include="@(_BclTestOutput)" />
    </ItemGroup>
  </Target>
  <Target Name="ForceBuild"
      DependsOnTargets="GetMonoBundleItems;$(ForceBuildDependsOn)"
      Inputs="$(MonoSourceFullPath)\autogen.sh;$(LlvmSourceFullPath)\Makefile.config.in"
      Outputs="@(BundleItem)">
  </Target>
  <Target Name="_BuildUnlessCached"
      DependsOnTargets="_SetAutogenShTimeToLastCommitTimestamp;GetMonoBundleItems"
      Inputs="$(MonoSourceFullPath)\autogen.sh;$(LlvmSourceFullPath)\Makefile.config.in"
      Outputs="@(BundleItem)">
    <PropertyGroup>
      <_Now>$([System.DateTime]::Now.Ticks)</_Now>
    </PropertyGroup>
    <MSBuild
        Projects="$(MSBuildThisFileDirectory)\mono-runtimes.csproj"
        Properties="_ForceXbuildToNotCacheTargets=$(_Now)"
        Targets="ForceBuild"
    />
  </Target>
  <Target Name="_CleanRuntimes"
      AfterTargets="Clean">
    <Exec
        Condition=" '%(_MonoRuntime.UseMonoSdks)' != 'False' "
        Command="make $(MakeConcurrency) clean-android-%(_MonoRuntime.Identity) CONFIGURATION=$(_MonoSdksConfiguration)"
        IgnoreStandardErrorWarningFormat="True"
        WorkingDirectory="$(MonoSourceFullPath)\sdks\builds"
    />
    <Exec
        Condition=" '%(_LlvmRuntime.UseMonoSdks)' != 'False' "
        Command="make $(MakeConcurrency) clean-llvm-%(_LlvmRuntime.Identity) CONFIGURATION=$(_MonoSdksConfiguration)"
        IgnoreStandardErrorWarningFormat="True"
        WorkingDirectory="$(MonoSourceFullPath)\sdks\builds"
    />
    <RemoveDir
        Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' "
        Directories="@(_MonoRuntime->'$(IntermediateOutputPath)\%(Identity)')"
    />
    <Delete
        Condition=" '%(_MonoRuntime.UseMonoSdks)' == 'False' "
        Files="@(_MonoRuntime->'$(IntermediateOutputPath)\%(Identity).config.cache')"
    />
    <RemoveDir
        Directories="@(_MonoCrossRuntime->'$(IntermediateOutputPath)\%(Identity)');$(_LlvmBuildDirWin32);$(_LlvmBuildDirWin64)"
    />
    <Delete
        Files="$(_CrossOutputPrefix)*.config.cache;$(_CrossOutputDirTop)\llvm*.config.cache"
    />
  </Target>

  <Target Name="CoreCompile"
      DependsOnTargets="_BuildRuntimes">
  </Target>
</Project>
