<!-- Legacy typemap: native binary typemaps generated by GenerateTypeMappings. -->
<Project>

  <UsingTask TaskName="Xamarin.Android.Tasks.CollectTypeMapFilesForArchive" AssemblyFile="Xamarin.Android.Build.Tasks.dll" />
  <UsingTask TaskName="Xamarin.Android.Tasks.CreateTypeManagerJava" AssemblyFile="Xamarin.Android.Build.Tasks.dll" />
  <UsingTask TaskName="Xamarin.Android.Tasks.GenerateTypeMappings" AssemblyFile="Xamarin.Android.Build.Tasks.dll" />
  <UsingTask TaskName="Xamarin.Android.Tasks.GetMonoPlatformJar" AssemblyFile="Xamarin.Android.Build.Tasks.dll" />
  <UsingTask TaskName="Xamarin.Android.Tasks.RemoveRegisterAttribute" AssemblyFile="Xamarin.Android.Build.Tasks.dll" />

  <PropertyGroup>
    <_RemoveRegisterFlag>$(MonoAndroidIntermediateAssemblyDir)shrunk\shrunk.flag</_RemoveRegisterFlag>
    <!-- Hook legacy JCW generation into _GenerateJavaStubs before manifest generation -->
    <_BeforeGenerateAndroidManifestTasks>_GenerateLegacyJavaCallableWrappers</_BeforeGenerateAndroidManifestTasks>
  </PropertyGroup>

  <!-- Legacy Java Callable Wrapper generation â€” runs as part of _GenerateJavaStubs,
       before manifest generation. This target is only imported for legacy typemap modes. -->
  <Target Name="_GenerateLegacyJavaCallableWrappers">
    <GenerateJavaCallableWrappers
        CodeGenerationTarget="$(_AndroidJcwCodegenTarget)"
        OutputDirectory="$(IntermediateOutputPath)android\src"
        ResolvedAssemblies="@(_ResolvedAssemblies)"
        PackageNamingPolicy="$(AndroidPackageNamingPolicy)"
        SupportedAbis="@(_BuildTargetAbis)">
      <Output TaskParameter="GeneratedJavaFilesOutput" ItemName="_GeneratedJavaFiles" />
    </GenerateJavaCallableWrappers>

    <GenerateACWMap
        AcwMapFile="$(_AcwMapFile)"
        IntermediateOutputDirectory="$(IntermediateOutputPath)"
        ResolvedAssemblies="@(_ResolvedAssemblies)"
        SupportedAbis="@(_BuildTargetAbis)">
    </GenerateACWMap>

    <GenerateJavaStubs
        CodeGenerationTarget="$(_AndroidJcwCodegenTarget)"
        ResolvedAssemblies="@(_ResolvedAssemblies)"
        ResolvedUserAssemblies="@(_ResolvedUserMonoAndroidAssemblies)"
        RunCheckedBuild="$(_AndroidJLOCheckedBuild)"
        GeneratedJavaFiles="@(_GeneratedJavaFiles)"
        ErrorOnCustomJavaObject="$(AndroidErrorOnCustomJavaObject)"
        Debug="$(AndroidIncludeDebugSymbols)"
        OutputDirectory="$(IntermediateOutputPath)android"
        PackageNamingPolicy="$(AndroidPackageNamingPolicy)"
        ApplicationJavaClass="$(AndroidApplicationJavaClass)"
        FrameworkDirectories="$(_XATargetFrameworkDirectories)"
        SupportedAbis="@(_BuildTargetAbis)"
        EnableMarshalMethods="$(_AndroidUseMarshalMethods)"
        IntermediateOutputDirectory="$(IntermediateOutputPath)"
        EnableNativeRuntimeLinking="$(_AndroidEnableNativeRuntimeLinking)">
    </GenerateJavaStubs>

    <RewriteMarshalMethods
        Condition=" '$(_AndroidUseMarshalMethods)' == 'true' And '$(AndroidIncludeDebugSymbols)' == 'false' "
        EnableManagedMarshalMethodsLookup="$(_AndroidUseManagedMarshalMethodsLookup)"
        Environments="@(_EnvironmentFiles)"
        IntermediateOutputDirectory="$(IntermediateOutputPath)">
    </RewriteMarshalMethods>

    <GenerateACWMap
        Condition=" '$(_AndroidJLOCheckedBuild)' == 'true' "
        AcwMapFile="$(_AcwMapFile)"
        RunCheckedBuild="true"
        IntermediateOutputDirectory="$(IntermediateOutputPath)"
        ResolvedAssemblies="@(_ResolvedAssemblies)"
        SupportedAbis="@(_BuildTargetAbis)">
    </GenerateACWMap>
  </Target>

  <!-- Legacy manifest generation and additional provider sources.
       Runs after _GenerateJavaStubs so that NativeCodeGenState is available. -->
  <Target Name="_GenerateLegacyAndroidManifest"
      AfterTargets="_GenerateJavaStubs">
    <GenerateMainAndroidManifest
        AndroidRuntime="$(_AndroidRuntime)"
        AndroidSdkDir="$(_AndroidSdkDirectory)"
        AndroidApiLevel="$(_AndroidApiLevel)"
        ApplicationJavaClass="$(AndroidApplicationJavaClass)"
        ApplicationLabel="$(_ApplicationLabel)"
        BundledWearApplicationName="$(BundledWearApplicationPackageName)"
        CheckedBuild="$(_AndroidCheckedBuild)"
        Debug="$(AndroidIncludeDebugSymbols)"
        EmbedAssemblies="$(EmbedAssembliesIntoApk)"
        EnableNativeRuntimeLinking="$(_AndroidEnableNativeRuntimeLinking)"
        IntermediateOutputDirectory="$(IntermediateOutputPath)"
        ManifestPlaceholders="$(AndroidManifestPlaceholders)"
        ManifestTemplate="$(_AndroidManifestAbs)"
        MergedAndroidManifestOutput="$(_ManifestOutput)"
        MergedManifestDocuments="@(_MergedManifestDocuments)"
        MultiDex="$(AndroidEnableMultiDex)"
        NeedsInternet="$(AndroidNeedsInternetPermission)"
        PackageName="$(_AndroidPackage)"
        ResolvedUserAssemblies="@(_ResolvedUserMonoAndroidAssemblies)"
        SupportedAbis="@(_BuildTargetAbis)"
        SupportedOSPlatformVersion="$(SupportedOSPlatformVersion)"
        VersionCode="$(_AndroidVersionCode)"
        VersionName="$(_AndroidVersionName)">
      <Output TaskParameter="AdditionalProviderSources" ItemName="_AdditionalProviderSources" />
    </GenerateMainAndroidManifest>

    <GenerateAdditionalProviderSources
        AdditionalProviderSources="@(_AdditionalProviderSources)"
        AndroidRuntime="$(_AndroidRuntime)"
        Environments="@(_EnvironmentFiles)"
        HttpClientHandlerType="$(AndroidHttpClientHandlerType)"
        EnableSGenConcurrent="$(AndroidEnableSGenConcurrent)"
        CodeGenerationTarget="$(_AndroidJcwCodegenTarget)"
        IntermediateOutputDirectory="$(IntermediateOutputPath)"
        OutputDirectory="$(IntermediateOutputPath)android"
        TargetName="$(TargetName)">
    </GenerateAdditionalProviderSources>
  </Target>

  <!-- Inject _TypeMapKind into the property cache -->
  <Target Name="_SetLegacyTypemapProperties"
      BeforeTargets="_CreatePropertiesCache">
    <PropertyGroup>
      <_TypeMapKind Condition=" '$(AndroidIncludeDebugSymbols)' != 'True' ">mvid</_TypeMapKind>
      <_TypeMapKind Condition=" '$(AndroidIncludeDebugSymbols)' == 'True' ">strings-asm</_TypeMapKind>
    </PropertyGroup>
    <ItemGroup>
      <_PropertyCacheItems Include="TypeMapKind=$(_TypeMapKind)" />
    </ItemGroup>
  </Target>

  <!-- Locate prebuilt mono.android.jar (overrides the empty stub in Common.targets) -->
  <Target Name="_GetMonoPlatformJarPath">
    <PropertyGroup>
      <_AndroidJarAndDexDirectory>$(_XATargetFrameworkDirectories)</_AndroidJarAndDexDirectory>
    </PropertyGroup>
    <GetMonoPlatformJar
        Condition=" '$(_AndroidUseMarshalMethods)' != 'True' and '$(_AndroidJcwCodegenTarget)' == 'XAJavaInterop1' "
        TargetFrameworkDirectory="$(_AndroidJarAndDexDirectory)">
      <Output TaskParameter="MonoPlatformJarPath" PropertyName="MonoPlatformJarPath" />
      <Output TaskParameter="MonoPlatformDexPath" PropertyName="MonoPlatformDexPath" />
    </GetMonoPlatformJar>
  </Target>

  <!-- Prepare native assembly sources for typemap (overrides the empty stub in Common.targets) -->
  <Target Name="_PrepareNativeAssemblySources" Condition=" '$(_AndroidRuntime)' != 'NativeAOT' ">
    <PrepareAbiItems
        BuildTargetAbis="@(_BuildTargetAbis)"
        NativeSourcesDir="$(_NativeAssemblySourceDir)"
        Debug="$(AndroidIncludeDebugSymbols)"
        Mode="typemap">
      <Output TaskParameter="AssemblySources" ItemName="_TypeMapAssemblySource" />
      <Output TaskParameter="AssemblyIncludes" ItemName="_TypeMapAssemblyInclude" />
    </PrepareAbiItems>
  </Target>

  <!-- Legacy TypeManager.java generation and prebuilt mono.android.jar copy -->
  <Target Name="_AddLegacyTypeManagerResources"
      AfterTargets="_AddStaticResources">
    <CreateTypeManagerJava
        Condition=" '$(_AndroidUseMarshalMethods)' == 'True' "
        ResourceName="JavaInteropTypeManager.java"
        OutputFilePath="$(_AndroidIntermediateJavaSourceDirectory)mono\TypeManager.java"
    />
    <Copy
        Condition=" '$(_AndroidUseMarshalMethods)' != 'True' and '$(_AndroidJcwCodegenTarget)' == 'XAJavaInterop1' "
        SourceFiles="$(MonoPlatformJarPath)"
        DestinationFiles="$(IntermediateOutputPath)android\bin\mono.android.jar"
        SkipUnchangedFiles="true" />
    <Touch
        Condition=" '$(_AndroidUseMarshalMethods)' != 'True' and '$(_AndroidJcwCodegenTarget)' == 'XAJavaInterop1' "
        Files="$(IntermediateOutputPath)android\bin\mono.android.jar" />
    <ItemGroup>
      <FileWrites Include="$(_AndroidIntermediateJavaSourceDirectory)mono\JavaInteropTypeManager.java" />
      <FileWrites
          Condition=" '$(_AndroidUseMarshalMethods)' != 'True' and '$(_AndroidJcwCodegenTarget)' == 'XAJavaInterop1' "
          Include="$(IntermediateOutputPath)android\bin\mono.android.jar" />
    </ItemGroup>
  </Target>

  <!-- Legacy native binary typemap generation -->
  <Target Name="_GenerateLegacyTypeMappings"
      AfterTargets="_GenerateJavaStubs">
    <GenerateTypeMappings
        AndroidRuntime="$(_AndroidRuntime)"
        Debug="$(AndroidIncludeDebugSymbols)"
        EnableMarshalMethods="$(_AndroidUseMarshalMethods)"
        IntermediateOutputDirectory="$(IntermediateOutputPath)"
        ResolvedAssemblies="@(_ResolvedAssemblies)"
        RunCheckedBuild="$(_AndroidJLOCheckedBuild)"
        SkipJniAddNativeMethodRegistrationAttributeScan="$(_SkipJniAddNativeMethodRegistrationAttributeScan)"
        SupportedAbis="@(_BuildTargetAbis)"
        TypemapImplementation="$(_AndroidTypeMapImplementation)"
        TypemapOutputDirectory="$(_NativeAssemblySourceDir)">
    </GenerateTypeMappings>
    <ItemGroup>
      <FileWrites Include="@(_TypeMapAssemblySource)" />
      <FileWrites Include="@(_TypeMapAssemblyInclude)" />
    </ItemGroup>
  </Target>

  <!-- Override _RemoveRegisterAttribute to strip [Register] attributes from shrunk assemblies -->
  <Target Name="_RemoveRegisterAttribute"
      DependsOnTargets="_PrepareAssemblies"
      Inputs="$(_AndroidLinkFlag)"
      Outputs="$(_RemoveRegisterFlag)"
      Condition="'$(AndroidLinkMode)' != 'None' AND '$(AndroidIncludeDebugSymbols)' != 'true'">
    <CopyIfChanged
        SourceFiles="@(_ResolvedAssemblies)"
        DestinationFiles="@(_ShrunkAssemblies)" />
    <CopyIfChanged
        SourceFiles="@(_ResolvedAssemblies->'%(Identity).config')"
        DestinationFiles="@(_ShrunkAssemblies->'%(Identity).config')" />
    <RemoveRegisterAttribute
        Condition=" '$(_AndroidRuntime)' != 'NativeAOT' and '$(PublishReadyToRun)' != 'true' "
        ShrunkFrameworkAssemblies="@(_ShrunkAssemblies)" />
    <MakeDir Directories="$(MonoAndroidIntermediateAssemblyDir)shrunk" />
    <Touch Files="$(_RemoveRegisterFlag)" AlwaysCreate="true" />
  </Target>

  <!-- Collect native typemap files for archive (FastDev) -->
  <Target Name="_CollectLegacyTypeMapFiles"
      BeforeTargets="_BuildApk">
    <CollectTypeMapFilesForArchive
        AndroidPackageFormat="$(AndroidPackageFormat)"
        TypeMappings="@(_AndroidTypeMaps)">
      <Output TaskParameter="FilesToAddToArchive" ItemName="FilesToAddToArchive" />
    </CollectTypeMapFilesForArchive>
  </Target>

</Project>
