<!--
***********************************************************************************************
Xamarin.Android.Tooling.targets

This file contains any calls to the <ResolveSdks/> or
<ResolveJdkJvmPath/> MSBuild tasks. It is imported and used by
"legacy" Xamarin.Android projects, binding projects, and .NET 5
projects.

***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask TaskName="Xamarin.Android.Tasks.GetJavaPlatformJar" AssemblyFile="Xamarin.Android.Build.Tasks.dll" />
  <UsingTask TaskName="Xamarin.Android.Tasks.ResolveSdks" AssemblyFile="Xamarin.Android.Build.Tasks.dll" />
  <UsingTask TaskName="Xamarin.Android.Tasks.ResolveJdkJvmPath" AssemblyFile="Xamarin.Android.Build.Tasks.dll" />

  <PropertyGroup>
    <_SetLatestTargetFrameworkVersionDependsOnTargets>
      _ResolveSdks;
      _ResolveAndroidTooling;
      _InjectAaptDependencies;
    </_SetLatestTargetFrameworkVersionDependsOnTargets>
  </PropertyGroup>

  <Target Name="_SetLatestTargetFrameworkVersion" DependsOnTargets="$(_SetLatestTargetFrameworkVersionDependsOnTargets)">
    <PropertyGroup>
      <TargetFrameworkMoniker Condition=" '$(TargetFrameworkProfile)' == '' ">$(TargetFrameworkIdentifier),Version=$(TargetFrameworkVersion)</TargetFrameworkMoniker>
      <TargetFrameworkMoniker Condition=" '$(TargetFrameworkProfile)' != '' ">$(TargetFrameworkIdentifier),Version=$(TargetFrameworkVersion),Profile=$(TargetFrameworkProfile)</TargetFrameworkMoniker>
      <NuGetTargetMoniker>$(TargetFrameworkMoniker)</NuGetTargetMoniker>
      <TargetFrameworkMonikerAssemblyAttributesPath>$(IntermediateOutputPath)$(TargetFrameworkMoniker).AssemblyAttributes$(DefaultLanguageSourceExtension)</TargetFrameworkMonikerAssemblyAttributesPath>
    </PropertyGroup>
    <ItemGroup>
      <FileWrites Include="$(TargetFrameworkMonikerAssemblyAttributesPath)" />
    </ItemGroup>
  </Target>

  <PropertyGroup>
    <_ResolveSdksDependsOnTargets>ProcessFrameworkReferences</_ResolveSdksDependsOnTargets>
  </PropertyGroup>

  <Target Name="_ResolveSdks" DependsOnTargets="$(_ResolveSdksDependsOnTargets)">
    <ItemGroup>
      <_AndroidApiInfo Include="$(MSBuildThisFileDirectory)..\data\*\AndroidApiInfo.xml" />
      <_AndroidApiInfoDirectories Include="@(_AndroidApiInfo->'%(RootDir)%(Directory)')" />
      <!--
        When using .NET 6+, provide the directory containing Mono.Android.dll and System.dll.
        Use %(TargetingPack.Path) / %(TargetingPack.PackageDirectory) to get this information.
        See: https://github.com/dotnet/sdk/blob/1b4646d2244ffa462e59f10bc752f2ff6f94b569/src/Tasks/Microsoft.NET.Build.Tasks/targets/Microsoft.NET.Sdk.FrameworkReferenceResolution.targets#L79-L93
      -->
      <_AndroidTargetingPackAssemblyPath
          Condition=" '%(TargetingPack.Identity)' == 'Microsoft.NETCore.App' "
          Include="$([MSBuild]::ValueOrDefault('%(TargetingPack.Path)', '%(TargetingPack.PackageDirectory)'))\ref\*\System.dll"
      />
      <_AndroidTargetingPackAssemblyPath
          Condition=" '%(TargetingPack.Identity)' == 'Microsoft.Android' "
          Include="$([MSBuild]::ValueOrDefault('%(TargetingPack.Path)', '%(TargetingPack.PackageDirectory)'))\ref\*\Mono.Android.dll"
      />
      <_AndroidTargetingPackDirectories Include="@(_AndroidTargetingPackAssemblyPath->'$([System.String]::Copy('%(RootDir)%(Directory)').TrimEnd('\'))')" Condition=" '%(_AndroidTargetingPackAssemblyPath.RootDir)%(_AndroidTargetingPackAssemblyPath.Directory)' != '' " />
    </ItemGroup>
    <PropertyGroup>
      <_AndroidAllowMissingSdkTooling Condition=" '$(_AndroidAllowMissingSdkTooling)' == '' ">False</_AndroidAllowMissingSdkTooling>
      <_XATargetFrameworkDirectories>@(_AndroidTargetingPackDirectories->Distinct())</_XATargetFrameworkDirectories>
    </PropertyGroup>
    <ResolveSdks
        ContinueOnError="$(_AndroidAllowMissingSdkTooling)"
        CommandLineToolsVersion="$(AndroidCommandLineToolsVersion)"
        AndroidSdkPath="$(AndroidSdkDirectory)"
        AndroidNdkPath="$(AndroidNdkDirectory)"
        JavaSdkPath="$(JavaSdkDirectory)"
        MinimumSupportedJavaVersion="$(MinimumSupportedJavaVersion)"
        LatestSupportedJavaVersion="$(LatestSupportedJavaVersion)"
        ReferenceAssemblyPaths="@(_AndroidApiInfoDirectories)">
      <Output TaskParameter="CommandLineToolsPath"      PropertyName="_AndroidToolsDirectory" />
      <Output TaskParameter="AndroidSdkPath"            PropertyName="AndroidSdkDirectory" Condition=" '$(AndroidSdkDirectory)' == '' " />
      <Output TaskParameter="JavaSdkPath"               PropertyName="JavaSdkDirectory"    Condition=" '$(JavaSdkDirectory)' == '' " />
      <Output TaskParameter="AndroidNdkPath"            PropertyName="_AndroidNdkDirectory" />
      <Output TaskParameter="AndroidSdkPath"            PropertyName="_AndroidSdkDirectory" />
      <Output TaskParameter="JavaSdkPath"               PropertyName="_JavaSdkDirectory" />
      <Output TaskParameter="MonoAndroidToolsPath"      PropertyName="MonoAndroidToolsDirectory" />
      <Output TaskParameter="MonoAndroidBinPath"        PropertyName="MonoAndroidBinDirectory" />
      <Output TaskParameter="MonoAndroidLibPath"        PropertyName="MonoAndroidLibDirectory" />
      <Output TaskParameter="AndroidBinUtilsPath"       PropertyName="AndroidBinUtilsDirectory" Condition=" '$(AndroidBinUtilsDirectory)' == '' " />
    </ResolveSdks>
    <ResolveJdkJvmPath
        JavaSdkPath="$(_JavaSdkDirectory)"
        MinimumSupportedJavaVersion="$(MinimumSupportedJavaVersion)"
        LatestSupportedJavaVersion="$(LatestSupportedJavaVersion)"
        Condition=" '$(DesignTimeBuild)' != 'True' And '$(AndroidGenerateJniMarshalMethods)' == 'True' And '$(JdkJvmPath)' == '' ">
      <Output TaskParameter="JdkJvmPath"                PropertyName="JdkJvmPath" />
    </ResolveJdkJvmPath>
  </Target>

  <Target Name="_GetJavaPlatformJar">
    <GetJavaPlatformJar
        AndroidSdkPlatform="$(_AndroidApiLevel)"
        AndroidSdkDirectory="$(AndroidSdkDirectory)"
        AndroidManifest="$(_AndroidManifestAbs)"
        DesignTimeBuild="$(DesignTimeBuild)"
        BuildingInsideVisualStudio="$(BuildingInsideVisualStudio)"
        SupportedOSPlatformVersion="$(SupportedOSPlatformVersion)"
        TargetFramework="$(TargetFramework)"
        TargetPlatformVersion="$(TargetPlatformVersion)"
    >
      <Output TaskParameter="JavaPlatformJarPath" PropertyName="JavaPlatformJarPath" />
      <Output TaskParameter="TargetSdkVersion"    PropertyName="_AndroidTargetSdkVersion" />
    </GetJavaPlatformJar>
  </Target>
</Project>
