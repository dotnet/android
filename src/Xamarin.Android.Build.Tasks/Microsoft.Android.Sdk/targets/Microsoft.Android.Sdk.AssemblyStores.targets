<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="Xamarin.Android.Tasks.CreateEmbeddedAssemblyStore" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.Tasks.PrepareAbiItems" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />

  <Target Name="_PrepareCreateEmbeddedAssemblyStoreOutputItems">
    <PrepareAbiItems
      BuildTargetAbis="@(_BuildTargetAbis)"
      NativeSourcesDir="$(_NativeAssemblySourceDir)"
      Mode="EmbeddedAssemblyStore">
    <Output TaskParameter="AssemblySources" ItemName="_EmbeddedAssemblyStoreSourceFiles" />
  </PrepareAbiItems>
  </Target>

  <Target Name="_CreateEmbeddedAssemblyStore"
          Condition=" '$(_AndroidEmbedAssemblyStoreInRuntime)' == 'True' "
          DependsOnTargets="_PrepareCreateEmbeddedAssemblyStoreOutputItems"
          Inputs="@(_ShrunkUserAssemblies);@(_AndroidResolvedSatellitePaths);@(_ShrunkFrameworkAssemblies)"
          Outputs="@(_EmbeddedAssemblyStoreSourceFiles)">
    <CreateEmbeddedAssemblyStore
        AndroidBinUtilsDirectory="$(AndroidBinUtilsDirectory)"
        AppSharedLibrariesDir="$(_AndroidApplicationSharedLibraryPath)"
        AssemblySourcesDir="$(IntermediateOutputPath)android"
        CompressedAssembliesDir="$(_AndroidCompressedAssembliesDir)\test\"
        Debug="$(AndroidIncludeDebugSymbols)"
        EnableCompression="$(AndroidEnableAssemblyCompression)"
        ProjectFullPath="$(MSBuildProjectFullPath)"
        ResolvedUserAssemblies="@(_ShrunkUserAssemblies);@(_AndroidResolvedSatellitePaths)"
        ResolvedFrameworkAssemblies="@(_ShrunkFrameworkAssemblies)"
        SupportedAbis="@(_BuildTargetAbis)" />

    <ItemGroup>
      <FileWrites Include="@(_EmbeddedAssemblyStoreSourceFiles)" />
    </ItemGroup>
  </Target>
</Project>
