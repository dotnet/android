<!--
***********************************************************************************************
Microsoft.Android.Sdk.Application.targets

This file contains targets specific for Android application projects.

***********************************************************************************************
-->
<Project>
  <UsingTask TaskName="Xamarin.Android.Tasks.AndroidAdb" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.Tasks.GetAndroidActivityName" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.Tasks.GetAvailableAndroidDevices" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.BuildTools.PrepTasks.XASleepInternal" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />

  <PropertyGroup>
    <!-- If Xamarin.Android.Common.Debugging.targets exists, we can rely on _Run for debugging. -->
    <_RunDependsOn Condition=" '$(_AndroidFastDeploymentSupported)' == 'true' ">
      Install;
      _Run;
    </_RunDependsOn>
    <_RunDependsOn Condition=" '$(_AndroidFastDeploymentSupported)' != 'true' ">
      Install;
      StartAndroidActivity;
    </_RunDependsOn>
    <_AndroidComputeRunArgumentsDependsOn Condition="$([MSBuild]::VersionGreaterThanOrEquals($(NetCoreSdkVersion), 10.0.200))">
      _ResolveMonoAndroidSdks;
      _GetAndroidPackageName;
    </_AndroidComputeRunArgumentsDependsOn>
    <_AndroidComputeRunArgumentsDependsOn Condition="$([MSBuild]::VersionLessThan($(NetCoreSdkVersion), 10.0.200))">
      Install;
    </_AndroidComputeRunArgumentsDependsOn>
  </PropertyGroup>

  <!--
  ***********************************************************************************************
  ComputeAvailableDevices

  Target that queries available Android devices and emulators.
  This target is called by 'dotnet run' to support device selection.
  Returns @(Devices) items with metadata: Description, Type, Status

  See: https://github.com/dotnet/sdk/blob/2b9fc02a265c735f2132e4e3626e94962e48bdf5/documentation/specs/dotnet-run-for-maui.md
  ***********************************************************************************************
  -->
  <Target Name="ComputeAvailableDevices"
      DependsOnTargets="_ResolveMonoAndroidSdks"
      Returns="@(Devices)">
    <GetAvailableAndroidDevices
        ToolExe="$(AdbToolExe)"
        ToolPath="$(AdbToolPath)">
      <Output TaskParameter="Devices" ItemName="Devices" />
    </GetAvailableAndroidDevices>
  </Target>

  <Target Name="_AndroidComputeRunArguments"
      BeforeTargets="ComputeRunArguments"
      DependsOnTargets="$(_AndroidComputeRunArgumentsDependsOn)">
    <GetAndroidActivityName
        Condition=" '$(AndroidLaunchActivity)' == '' "
        ManifestFile="$(IntermediateOutputPath)android\AndroidManifest.xml">
      <Output TaskParameter="ActivityName" PropertyName="AndroidLaunchActivity" />
    </GetAndroidActivityName>
    <PropertyGroup>
      <RunCommand>$(AdbToolExe)</RunCommand>
      <RunCommand Condition=" $(RunCommand) == '' and $([MSBuild]::IsOSPlatform('windows')) ">adb.exe</RunCommand>
      <RunCommand Condition=" $(RunCommand) == '' and !$([MSBuild]::IsOSPlatform('windows')) ">adb</RunCommand>
      <RunCommand>$([System.IO.Path]::Combine ('$(AdbToolPath)', '$(RunCommand)'))</RunCommand>
      <RunArguments>$(AdbTarget) shell am start -S -n &quot;$(_AndroidPackage)/$(AndroidLaunchActivity)&quot;</RunArguments>
      <RunWorkingDirectory>$(MSBuildProjectDirectory)</RunWorkingDirectory>
    </PropertyGroup>
  </Target>

  <Target Name="Run" DependsOnTargets="$(_RunDependsOn)" />

  <PropertyGroup>
    <_RunWithLoggingDependsOn>
      Install;
    </_RunWithLoggingDependsOn>

    <_RunLogFilePath Condition=" '$(_RunLogFilePath)' == '' ">$(IntermediateOutputPath)logcat.txt</_RunLogFilePath>
    <RunLogVerbose Condition=" '$(RunLogVerbose)' == '' ">false</RunLogVerbose>
  </PropertyGroup>

  <Target Name="RunWithLogging"
          DependsOnTargets="$(_RunWithLoggingDependsOn)">
    <GetAndroidActivityName
        Condition=" '$(AndroidLaunchActivity)' == '' "
        ManifestFile="$(IntermediateOutputPath)android\AndroidManifest.xml">
      <Output TaskParameter="ActivityName" PropertyName="AndroidLaunchActivity" />
    </GetAndroidActivityName>

    <PropertyGroup>
      <_MonoLog>default,assembly,timing=bare</_MonoLog>
      <_MonoLog Condition=" '$(RunLogVerbose)' != 'false' ">$(_MonoLog),mono_log_level=debug,mono_log_mask=all</_MonoLog>
      <RunLogDelayInMS>1000</RunLogDelayInMS> <!-- milliseconds -->
    </PropertyGroup>

    <Message Text="Preparing application to log more information" Importance="High" />
    <Message Text="Setting the debug.mono.log property to: $(_MonoLog)" Importance="High" />
    <AndroidAdb
      ToolExe="$(AdbToolExe)"
      ToolPath="$(AdbToolPath)"
      AdbTarget="$(AdbTarget)"
      Command="shell"
      Arguments="setprop debug.mono.log $(_MonoLog)"
    />
    <AndroidAdb
      ToolExe="$(AdbToolExe)"
      ToolPath="$(AdbToolPath)"
      AdbTarget="$(AdbTarget)"
      Command="logcat"
      Arguments="-G 16M"
    />
    <AndroidAdb
      ToolExe="$(AdbToolExe)"
      ToolPath="$(AdbToolPath)"
      AdbTarget="$(AdbTarget)"
      Command="logcat"
      Arguments="-c"
    />

    <Message Text="Running the application and waiting for it to fully start" Importance="High" />
    <AndroidAdb
      ToolExe="$(AdbToolExe)"
      ToolPath="$(AdbToolPath)"
      AdbTarget="$(AdbTarget)"
      Command="shell"
      Arguments="am start -S -W -n &quot;$(_AndroidPackage)/$(AndroidLaunchActivity)&quot;"
    />

    <Message Text="Sleeping for $(RunLogDelayInMS)ms to give logcat a chance to log all the messages" Importance="High" />
    <XASleepInternal Milliseconds="$(RunLogDelayInMS)" />

    <AndroidAdb
      ToolExe="$(AdbToolExe)"
      ToolPath="$(AdbToolPath)"
      AdbTarget="$(AdbTarget)"
      Command="logcat"
      Arguments="-d"
      >
      <Output TaskParameter="Result" PropertyName="_LogcatOutput" />
    </AndroidAdb>
    <WriteLinesToFile
      File="$(_RunLogFilePath)"
      Lines="$(_LogcatOutput)"
      Overwrite="true"
    />
    <Message Text="Logcat output is available in $(_RunLogFilePath)" Importance="High" />
  </Target>
</Project>
