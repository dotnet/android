<!--
***********************************************************************************************
Microsoft.Android.Sdk.Application.targets

This file contains targets specific for Android application projects.

***********************************************************************************************
-->
<Project>
  <UsingTask TaskName="Xamarin.Android.Tasks.AndroidAdb" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.Tasks.GetAndroidActivityName" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.Tasks.GetAvailableAndroidDevices" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.Tasks.BootAndroidEmulator" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.BuildTools.PrepTasks.XASleepInternal" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />

  <PropertyGroup>
    <!-- If Xamarin.Android.Common.Debugging.targets exists, we can rely on _Run for debugging. -->
    <_RunDependsOn Condition=" '$(_AndroidFastDeploymentSupported)' == 'true' ">
      Install;
      _Run;
    </_RunDependsOn>
    <_RunDependsOn Condition=" '$(_AndroidFastDeploymentSupported)' != 'true' ">
      Install;
      StartAndroidActivity;
    </_RunDependsOn>
    <_AndroidComputeRunArgumentsDependsOn Condition=" '$(_AndroidComputeRunArgumentsDependsOn)' == '' ">
      _ResolveMonoAndroidSdks;
      _GetAndroidPackageName;
    </_AndroidComputeRunArgumentsDependsOn>
  </PropertyGroup>

  <!--
  ***********************************************************************************************
  ComputeAvailableDevices

  Target that queries available Android devices and emulators.
  This target is called by 'dotnet run' to support device selection.
  Returns @(Devices) items with metadata: Description, Type, Status

  See: https://github.com/dotnet/sdk/blob/2b9fc02a265c735f2132e4e3626e94962e48bdf5/documentation/specs/dotnet-run-for-maui.md
  ***********************************************************************************************
  -->
  <Target Name="ComputeAvailableDevices"
      DependsOnTargets="_ResolveMonoAndroidSdks"
      Returns="@(Devices)">
    <GetAvailableAndroidDevices
        ToolExe="$(AdbToolExe)"
        ToolPath="$(AdbToolPath)"
        EmulatorToolExe="$(EmulatorToolExe)"
        EmulatorToolPath="$(EmulatorToolPath)">
      <Output TaskParameter="Devices" ItemName="Devices" />
    </GetAvailableAndroidDevices>
  </Target>

  <!--
  ***********************************************************************************************
  _EnsureDeviceBooted

  Target that ensures the selected device is online and ready. If $(Device) refers to an
  unbooted AVD, this target boots the emulator and updates $(AdbTarget) to the resolved
  ADB serial (e.g. "-s emulator-5554").
  Runs before _GetPrimaryCpuAbi (in commercial builds) so $(AdbTarget) is correct,
  and before _DeployApk/_DeployAppBundle (which use AdbTarget for adb commands)
  when $(Device) is set.

  Note: this target CANNOT use DependsOnTargets="_ResolveMonoAndroidSdks" because in commercial
  builds _GetPrimaryCpuAbi is in $(_ResolveMonoAndroidSdksDependsOn), which would create a cycle:
    _ResolveMonoAndroidSdks -> _GetPrimaryCpuAbi -> _EnsureDeviceBooted -> _ResolveMonoAndroidSdks
  Instead, the task computes tool paths from $(AndroidSdkDirectory), which is available because
  _ResolveSdks runs earlier in the dependency chain.
  ***********************************************************************************************
  -->
  <Target Name="_EnsureDeviceBooted"
      BeforeTargets="_GetPrimaryCpuAbi;_DeployApk;_DeployAppBundle"
      Condition=" '$(Device)' != '' ">
    <BootAndroidEmulator
        Device="$(Device)"
        AndroidSdkDirectory="$(AndroidSdkDirectory)"
        EmulatorToolExe="$(EmulatorToolExe)"
        EmulatorToolPath="$(EmulatorToolPath)"
        AdbToolExe="$(AdbToolExe)"
        AdbToolPath="$(AdbToolPath)"
        BootTimeoutSeconds="$(BootTimeoutSeconds)"
        EmulatorExtraArguments="$(EmulatorExtraArguments)">
      <Output TaskParameter="AdbTarget" PropertyName="AdbTarget" />
    </BootAndroidEmulator>
  </Target>

  <Target Name="_AndroidComputeRunArguments"
      BeforeTargets="ComputeRunArguments"
      DependsOnTargets="$(_AndroidComputeRunArgumentsDependsOn)">
    <GetAndroidActivityName
        Condition=" '$(AndroidLaunchActivity)' == '' "
        ManifestFile="$(IntermediateOutputPath)android\AndroidManifest.xml">
      <Output TaskParameter="ActivityName" PropertyName="AndroidLaunchActivity" />
    </GetAndroidActivityName>
    <PropertyGroup>
      <_AdbToolPath>$(AdbToolExe)</_AdbToolPath>
      <_AdbToolPath Condition=" '$(_AdbToolPath)' == '' and $([MSBuild]::IsOSPlatform('windows')) ">adb.exe</_AdbToolPath>
      <_AdbToolPath Condition=" '$(_AdbToolPath)' == '' and !$([MSBuild]::IsOSPlatform('windows')) ">adb</_AdbToolPath>
      <_AdbToolPath>$([System.IO.Path]::Combine ('$(AdbToolPath)', '$(_AdbToolPath)'))</_AdbToolPath>
      <RunWorkingDirectory>$(MSBuildProjectDirectory)</RunWorkingDirectory>
    </PropertyGroup>
    <!-- By default, use `Microsoft.Android.Run` tool to stream logcat and handle Ctrl+C -->
    <PropertyGroup Condition=" '$(WaitForExit)' != 'false' ">
      <_AndroidRunPath Condition=" '$(_AndroidRunPath)' == '' ">$(MSBuildThisFileDirectory)..\tools\Microsoft.Android.Run.dll</_AndroidRunPath>
      <_AndroidRunLogcatArgs Condition=" '$(_AndroidRunLogcatArgs)' == '' ">monodroid-assembly:S</_AndroidRunLogcatArgs>
      <_AndroidRunAdbTargetArg Condition=" '$(AdbTarget)' != '' ">--adb-target &quot;$(AdbTarget)&quot;</_AndroidRunAdbTargetArg>
      <RunCommand>dotnet</RunCommand>
      <RunArguments>exec &quot;$(_AndroidRunPath)&quot; --adb &quot;$(_AdbToolPath)&quot; $(_AndroidRunAdbTargetArg) --package &quot;$(_AndroidPackage)&quot; --activity &quot;$(AndroidLaunchActivity)&quot; --logcat-args &quot;$(_AndroidRunLogcatArgs)&quot; $(_AndroidRunExtraArgs)</RunArguments>
    </PropertyGroup>
    <!-- When WaitForExit is false, use direct adb command (no logcat streaming) -->
    <PropertyGroup Condition=" '$(WaitForExit)' == 'false' ">
      <RunCommand>$(_AdbToolPath)</RunCommand>
      <RunArguments>$(AdbTarget) shell am start -S -n &quot;$(_AndroidPackage)/$(AndroidLaunchActivity)&quot;</RunArguments>
    </PropertyGroup>
  </Target>

  <Target Name="Run" DependsOnTargets="$(_RunDependsOn)" />

  <PropertyGroup>
    <_RunWithLoggingDependsOn>
      Install;
    </_RunWithLoggingDependsOn>

    <_RunLogFilePath Condition=" '$(_RunLogFilePath)' == '' ">$(IntermediateOutputPath)logcat.txt</_RunLogFilePath>
    <RunLogVerbose Condition=" '$(RunLogVerbose)' == '' ">false</RunLogVerbose>
  </PropertyGroup>

  <Target Name="RunWithLogging"
          DependsOnTargets="$(_RunWithLoggingDependsOn)">
    <GetAndroidActivityName
        Condition=" '$(AndroidLaunchActivity)' == '' "
        ManifestFile="$(IntermediateOutputPath)android\AndroidManifest.xml">
      <Output TaskParameter="ActivityName" PropertyName="AndroidLaunchActivity" />
    </GetAndroidActivityName>

    <PropertyGroup>
      <_MonoLog>default,assembly,timing=bare</_MonoLog>
      <_MonoLog Condition=" '$(RunLogVerbose)' != 'false' ">$(_MonoLog),mono_log_level=debug,mono_log_mask=all</_MonoLog>
      <RunLogDelayInMS>1000</RunLogDelayInMS> <!-- milliseconds -->
    </PropertyGroup>

    <Message Text="Preparing application to log more information" Importance="High" />
    <Message Text="Setting the debug.mono.log property to: $(_MonoLog)" Importance="High" />
    <AndroidAdb
      ToolExe="$(AdbToolExe)"
      ToolPath="$(AdbToolPath)"
      AdbTarget="$(AdbTarget)"
      Command="shell"
      Arguments="setprop debug.mono.log $(_MonoLog)"
    />
    <AndroidAdb
      ToolExe="$(AdbToolExe)"
      ToolPath="$(AdbToolPath)"
      AdbTarget="$(AdbTarget)"
      Command="logcat"
      Arguments="-G 16M"
    />
    <AndroidAdb
      ToolExe="$(AdbToolExe)"
      ToolPath="$(AdbToolPath)"
      AdbTarget="$(AdbTarget)"
      Command="logcat"
      Arguments="-c"
    />

    <Message Text="Running the application and waiting for it to fully start" Importance="High" />
    <AndroidAdb
      ToolExe="$(AdbToolExe)"
      ToolPath="$(AdbToolPath)"
      AdbTarget="$(AdbTarget)"
      Command="shell"
      Arguments="am start -S -W -n &quot;$(_AndroidPackage)/$(AndroidLaunchActivity)&quot;"
    />

    <Message Text="Sleeping for $(RunLogDelayInMS)ms to give logcat a chance to log all the messages" Importance="High" />
    <XASleepInternal Milliseconds="$(RunLogDelayInMS)" />

    <AndroidAdb
      ToolExe="$(AdbToolExe)"
      ToolPath="$(AdbToolPath)"
      AdbTarget="$(AdbTarget)"
      Command="logcat"
      Arguments="-d"
      >
      <Output TaskParameter="Result" PropertyName="_LogcatOutput" />
    </AndroidAdb>
    <WriteLinesToFile
      File="$(_RunLogFilePath)"
      Lines="$(_LogcatOutput)"
      Overwrite="true"
    />
    <Message Text="Logcat output is available in $(_RunLogFilePath)" Importance="High" />
  </Target>
</Project>
