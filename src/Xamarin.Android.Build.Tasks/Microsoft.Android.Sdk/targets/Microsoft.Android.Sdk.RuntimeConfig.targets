<!--
***********************************************************************************************
Microsoft.Android.Sdk.RuntimeConfig.targets

MSBuild logic related to *.runtimeconfig.json files.

See: https://github.com/dotnet/runtime/blob/b13715b6984889a709ba29ea8a1961db469f8805/src/mono/nuget/Microsoft.NET.Runtime.RuntimeConfigParser.Task/README.md

***********************************************************************************************
-->
<Project>

  <PropertyGroup>
    <_BinaryRuntimeConfigPath>$(IntermediateOutputPath)$(ProjectRuntimeConfigFileName).bin</_BinaryRuntimeConfigPath>
    <!-- The TypeMappingEntryAssembly tells the .NET Type Mapping API which assembly to scan first
         for TypeMapAttribute entries. We use the generated _Microsoft.Android.TypeMaps assembly
         which contains all Java-to-.NET type mappings. This assembly is generated BEFORE ILLink
         by the GenerateTypeMapAssembly MSBuild task. -->
    <TypeMapEntryAssembly Condition="'$(TypeMapEntryAssembly)' == ''">_Microsoft.Android.TypeMaps</TypeMapEntryAssembly>
  </PropertyGroup>

  <ItemGroup>
    <!--
      See: https://docs.microsoft.com/en-us/dotnet/core/tutorials/netcore-hosting#step-3-%2D-prepare-runtime-properties
      These properties shouldn't be used in .NET for Android apps as there are no directories the runtime can search,
      everything related to assemblies or shared libraries must go through the .NET for Android native runtime.
    -->
    <_RuntimeConfigReservedProperties Include="TRUSTED_PLATFORM_ASSEMBLIES"/>
    <_RuntimeConfigReservedProperties Include="APP_PATHS"/>
    <_RuntimeConfigReservedProperties Include="APP_NI_PATHS"/>
    <_RuntimeConfigReservedProperties Include="NATIVE_DLL_SEARCH_DIRECTORIES"/>
    <_RuntimeConfigReservedProperties Include="PLATFORM_RESOURCE_ROOTS"/>
    <_RuntimeConfigReservedProperties Include="PINVOKE_OVERRIDE"/>
    <_RuntimeConfigReservedProperties Include="RUNTIME_IDENTIFIER"/>
    <_RuntimeConfigReservedProperties Include="APP_CONTEXT_BASE_DIRECTORY"/>
  </ItemGroup>

  <ItemGroup>
    <!-- Default RuntimeHostConfigurationOptions -->
    <RuntimeHostConfigurationOption Include="Xamarin.Android.Net.UseNegotiateAuthentication"
        Condition="'$(AndroidUseNegotiateAuthentication)' != ''"
        Value="$(AndroidUseNegotiateAuthentication)"
        Trim="true" />
    <!-- https://github.com/dotnet/runtime/blob/211cdd011f19a51b7092d8365e11e774a8280afb/src/libraries/System.Private.CoreLib/src/System/LocalAppContextSwitches.cs#L52 -->
    <RuntimeHostConfigurationOption Include="Switch.System.Reflection.ForceInterpretedInvoke"
        Value="$(AndroidAvoidEmitForPerformance)"
        Trim="true"
    />
    <!-- https://github.com/dotnet/runtime/commit/fecf3eeffd3650566555e15292f9df0d3abcdfc6 -->
    <RuntimeHostConfigurationOption Include="Microsoft.Extensions.DependencyInjection.DisableDynamicEngine"
        Value="$(AndroidAvoidEmitForPerformance)"
        Trim="true"
    />
    <!-- NOTE: Do NOT set Trim="true" here - TypeMappingEntryAssembly is NOT a boolean feature switch.
         ILLink receives this via the dedicated - -typemap-entry-assembly flag (set via $(TypeMapEntryAssembly) property).
         This RuntimeHostConfigurationOption is only for runtime configuration. -->
    <RuntimeHostConfigurationOption Include="System.Runtime.InteropServices.TypeMappingEntryAssembly"
        Value="$(TypeMapEntryAssembly)"
        Condition="'$(TypeMapEntryAssembly)' != ''"
    />
    <RuntimeHostConfigurationOption Include="Microsoft.Android.Runtime.RuntimeFeature.IsAssignableFromCheck"
        Condition="'$(_AndroidIsAssignableFromCheck)' != ''"
        Value="$(_AndroidIsAssignableFromCheck)"
        Trim="true"
    />
    <!-- Disable dynamic type registration when TypeMap V3 is enabled - all types are registered at build time -->
    <RuntimeHostConfigurationOption Include="Microsoft.Android.Runtime.RuntimeFeature.IsDynamicTypeRegistration"
        Condition="'$(AndroidEnableTypeMaps)' == 'true'"
        Value="false"
        Trim="true"
    />
  </ItemGroup>

  <!-- Skip RuntimeConfigParserTask for CoreCLR - the task comes from MonoTargets SDK which isn't available for CoreCLR builds -->
  <Target Name="_ParseRuntimeConfigFiles"
      AfterTargets="GenerateBuildRuntimeConfigurationFiles"
      Condition=" '$(GenerateRuntimeConfigurationFiles)' == 'true' and '$(_AndroidRuntime)' != 'CoreCLR' "
      Inputs="$(ProjectRuntimeConfigFilePath)"
      Outputs="$(_BinaryRuntimeConfigPath)">
    <RuntimeConfigParserTask
        RuntimeConfigFile="$(ProjectRuntimeConfigFilePath)"
        OutputFile="$(_BinaryRuntimeConfigPath)"
        RuntimeConfigReservedProperties="@(_RuntimeConfigReservedProperties)"
    />
    <ItemGroup>
      <FileWrites Include="$(_BinaryRuntimeConfigPath)" />
    </ItemGroup>
  </Target>

</Project>
