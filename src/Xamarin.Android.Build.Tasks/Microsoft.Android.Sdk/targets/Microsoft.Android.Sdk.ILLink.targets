<!--
***********************************************************************************************
Microsoft.Android.Sdk.ILLink.targets

This file contains the .NET 5-specific targets to customize ILLink

***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="_PrepareLinking"
      Condition=" '$(PublishTrimmed)' == 'true' "
      AfterTargets="ComputeResolvedFilesToPublishList"
      DependsOnTargets="GetReferenceAssemblyPaths">
    <ItemGroup>
      <!-- Mark all assemblies to be linked for AndroidLinkMode=Full -->
      <ResolvedFileToPublish
          Update="@(ResolvedFileToPublish)"
          Condition=" '$(AndroidLinkMode)' == 'Full' and '%(ResolvedFileToPublish.Extension)' == '.dll' and '%(ResolvedFileToPublish.AssetType)' != 'native' "
          TrimMode="link"
      />
      <!-- Mark our entry assembly as a root assembly. -->
      <TrimmerRootAssembly Include="$(AssemblyName)" />
    </ItemGroup>
    <PropertyGroup>
      <!-- make the output verbose to see what the linker is doing. FIXME: make dependent upon verbosity level -->
      <_ExtraTrimmerArgs>$(_ExtraTrimmerArgs) --verbose --deterministic --custom-data XATargetFrameworkDirectories="$(_XATargetFrameworkDirectories)"</_ExtraTrimmerArgs>

      <!-- we don't want to ignore stuff we can't find -->
      <_ExtraTrimmerArgs>$(_ExtraTrimmerArgs) --skip-unresolved false</_ExtraTrimmerArgs>
      <_AdditionalTaskAssemblyDirectory>$(XamarinSdkRootDirectory)tools/dotnet-linker/</_AdditionalTaskAssemblyDirectory>
      <_AdditionalTaskAssembly>$(_AdditionalTaskAssemblyDirectory)dotnet-linker.dll</_AdditionalTaskAssembly>
    </PropertyGroup>
    <PropertyGroup
        Condition=" '$(_ProguardProjectConfiguration)' != '' ">
      <_ExtraTrimmerArgs>$(_ExtraTrimmerArgs) --custom-data ProguardConfiguration="$(_ProguardProjectConfiguration)"</_ExtraTrimmerArgs>
    </PropertyGroup>
    <ItemGroup>
      <!-- add our custom steps -->
      <_TrimmerCustomSteps Include="$(MSBuildThisFileDirectory)..\tools\Microsoft.Android.Sdk.ILLink.dll">
        <BeforeStep>LoadReferencesStep</BeforeStep>
        <Type>Microsoft.Android.Sdk.ILLink.SetupStep</Type>
      </_TrimmerCustomSteps>
    </ItemGroup>
  </Target>

  <Target Name="_LinkAssemblies"
      DependsOnTargets="_ResolveAssemblies;_CreatePackageWorkspace;$(_BeforeLinkAssemblies);_GenerateJniMarshalMethods;_LinkAssembliesNoShrink"
  />

  <Target Name="_TouchAndroidLinkFlag"
      AfterTargets="ILLink"
      Condition=" '$(PublishTrimmed)' == 'true' and Exists('$(_LinkSemaphore)') "
      Inputs="$(_LinkSemaphore)"
      Outputs="$(_AndroidLinkFlag)">
    <!-- This file is an input for _RemoveRegisterAttribute -->
    <Touch Files="$(_AndroidLinkFlag)" AlwaysCreate="true" />
  </Target>

</Project>
