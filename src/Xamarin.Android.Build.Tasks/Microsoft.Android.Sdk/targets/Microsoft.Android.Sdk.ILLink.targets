<!--
***********************************************************************************************
Microsoft.Android.Sdk.ILLink.targets

This file contains the .NET 5-specific targets to customize ILLink

***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask TaskName="Xamarin.Android.Tasks.GenerateTypeMapAssembly" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />

  <!--
    Generate the TypeMap assembly BEFORE ILLink runs.
    This task scans assemblies for [Register] attributes and generates _Microsoft.Android.TypeMaps.dll
    containing TypeMapAttribute entries. The generated assembly is included in the ILLink input
    so that type mappings affect trimming decisions.
  -->
  <Target Name="_GenerateTypeMapAssembly"
      Condition=" '$(PublishTrimmed)' == 'true' "
      DependsOnTargets="_ComputeManagedAssemblyToLink"
      BeforeTargets="_RunILLink">
    <PropertyGroup>
      <_TypeMapAssemblyOutputDir>$(IntermediateOutputPath)typemap\</_TypeMapAssemblyOutputDir>
      <_TypeMapJavaSourceOutputDir>$(_AndroidIntermediateJavaSourceDirectory)</_TypeMapJavaSourceOutputDir>
      <_TypeMapLlvmIrOutputDir>$(IntermediateOutputPath)android\</_TypeMapLlvmIrOutputDir>
    </PropertyGroup>
    
    <!-- Build list of assemblies to scan: prefer ManagedAssemblyToLink, otherwise collect from intermediate -->
    <ItemGroup>
      <_TypeMapInputAssemblies Include="@(ManagedAssemblyToLink)" Condition=" '@(ManagedAssemblyToLink)' != '' " />
      <!-- Fallback: gather published assemblies from intermediate directory -->
      <_TypeMapInputAssemblies Include="$(IntermediateOutputPath)*.dll" Condition=" '@(ManagedAssemblyToLink)' == '' " />
      <_TypeMapInputAssemblies Include="@(ReferencePath)" Condition=" '@(ManagedAssemblyToLink)' == '' and '%(ReferencePath.FileName)' == 'Mono.Android' " />
    </ItemGroup>
    
    <Message Importance="high" Text="[GTMA] ManagedAssemblyToLink count: @(ManagedAssemblyToLink->Count())" />
    <Message Importance="high" Text="[GTMA] _TypeMapInputAssemblies count: @(_TypeMapInputAssemblies->Count())" />
    <Message Importance="high" Text="[GTMA] Input assemblies: @(_TypeMapInputAssemblies->'%(FileName)')" Condition=" '@(_TypeMapInputAssemblies->Count())' != '0' " />
    
    <GenerateTypeMapAssembly
        ResolvedAssemblies="@(_TypeMapInputAssemblies)"
        OutputDirectory="$(_TypeMapAssemblyOutputDir)"
        JavaSourceOutputDirectory="$(_TypeMapJavaSourceOutputDir)"
        LlvmIrOutputDirectory="$(_TypeMapLlvmIrOutputDir)"
        CustomViewMapFile="$(_OuterCustomViewMapFile)"
        ErrorOnCustomJavaObject="$(AndroidErrorOnCustomJavaObject)">
      <Output TaskParameter="GeneratedAssembly" ItemName="_TypeMapGeneratedAssembly" />
      <Output TaskParameter="TypeMapEntryAssemblyName" PropertyName="_TypeMapEntryAssemblyName" />
      <Output TaskParameter="UpdatedResolvedAssemblies" ItemName="_TypeMapUpdatedAssemblies" />
      <Output TaskParameter="GeneratedJavaFiles" ItemName="_GeneratedJavaFiles" />
    </GenerateTypeMapAssembly>

    <!-- Update TypeMapEntryAssembly to point to the generated assembly -->
    <PropertyGroup Condition=" '$(_TypeMapEntryAssemblyName)' != '' ">
      <TypeMapEntryAssembly>$(_TypeMapEntryAssemblyName)</TypeMapEntryAssembly>
    </PropertyGroup>

    <!-- Add the generated TypeMaps assembly to ManagedAssemblyToLink so ILLink processes it.
         Use TrimMode="copy" for PoC because ILLink doesn't yet have typemap-entry-assembly support.
         When the SDK with dotnet/runtime#121513 is available, use the typemap-entry-assembly flag. -->
    <Message Importance="high" Text="DEBUG: _TypeMapGeneratedAssembly='@(_TypeMapGeneratedAssembly)'" />
    <Message Importance="high" Text="DEBUG: ManagedAssemblyToLink count BEFORE adding TypeMaps: @(ManagedAssemblyToLink->Count())" />
    <ItemGroup Condition=" '@(_TypeMapGeneratedAssembly)' != '' ">
      <ManagedAssemblyToLink Include="@(_TypeMapGeneratedAssembly)" TrimMode="copy" />
    </ItemGroup>
    <Message Importance="high" Text="DEBUG: ManagedAssemblyToLink count AFTER adding TypeMaps: @(ManagedAssemblyToLink->Count())" />

    <!-- Replace only the assembly items in ResolvedFileToPublish, preserve non-assembly items (native libs, etc.) -->
    <ItemGroup Condition=" '@(_TypeMapUpdatedAssemblies)' != '' ">
      <!-- Save non-assembly items (native libs, config files, etc.) -->
      <_ResolvedFileToPublishNonAssembly Include="@(ResolvedFileToPublish)" Condition=" '%(Extension)' != '.dll' " />
      <!-- Remove all items -->
      <ResolvedFileToPublish Remove="@(ResolvedFileToPublish)" />
      <!-- Re-add: updated assemblies + preserved non-assemblies -->
      <ResolvedFileToPublish Include="@(_TypeMapUpdatedAssemblies)" />
      <ResolvedFileToPublish Include="@(_ResolvedFileToPublishNonAssembly)" />
      <!-- Also add the TypeMaps assembly to the publish list -->
      <ResolvedFileToPublish Include="@(_TypeMapGeneratedAssembly)" />
    </ItemGroup>

    <Message Condition=" '@(_TypeMapGeneratedAssembly)' != '' " Importance="high" 
             Text="Generated TypeMap assembly: @(_TypeMapGeneratedAssembly) (TypeMapEntryAssembly=$(TypeMapEntryAssembly))" />
  </Target>

  <Target Name="_PrepareLinking"
      Condition=" '$(PublishTrimmed)' == 'true' "
      AfterTargets="ComputeResolvedFilesToPublishList"
      DependsOnTargets="GetReferenceAssemblyPaths;_CreatePropertiesCache;_GenerateTypeMapAssembly">
    <PropertyGroup>
      <TrimmerRemoveSymbols Condition=" '$(AndroidIncludeDebugSymbols)' != 'true' ">true</TrimmerRemoveSymbols>
      <_ExtraTrimmerArgs Condition=" '$(_EnableSerializationDiscovery)' != 'false' ">--enable-serialization-discovery $(_ExtraTrimmerArgs)</_ExtraTrimmerArgs>
      <_ExtraTrimmerArgs Condition=" '$(_AndroidEnableUnusedTypeChecks)' != 'true' ">--disable-opt unusedtypechecks $(_ExtraTrimmerArgs)</_ExtraTrimmerArgs>
      <!-- TypeMapEntryAssembly is set by _GenerateTypeMapAssembly, or defaults to Mono.Android for MonoVM -->
      <TypeMapEntryAssembly Condition=" '$(TypeMapEntryAssembly)' == '' ">Mono.Android</TypeMapEntryAssembly>
      <!-- Pass the TypeMap entry assembly to ILLink so it can populate TypeMapping dictionaries (dotnet/runtime#121513) -->
      <_ExtraTrimmerArgs>--typemap-entry-assembly $(TypeMapEntryAssembly) $(_ExtraTrimmerArgs)</_ExtraTrimmerArgs>
      <!--
        Used for the <ILLink DumpDependencies="$(_TrimmerDumpDependencies)" /> value:
        https://github.com/dotnet/sdk/blob/a5393731b5b7b225692fff121f747fbbc9e8b140/src/Tasks/Microsoft.NET.Build.Tasks/targets/Microsoft.NET.ILLink.targets#L150
        -->
      <_TrimmerDumpDependencies Condition=" '$(LinkerDumpDependencies)' == 'true' ">true</_TrimmerDumpDependencies>
      <_AndroidLinkerCustomStepAssembly>$(MSBuildThisFileDirectory)..\tools\Microsoft.Android.Sdk.ILLink.dll</_AndroidLinkerCustomStepAssembly>
      <_SystemIOHashingAssemblyPath>$(MSBuildThisFileDirectory)..\tools\System.IO.Hashing.dll</_SystemIOHashingAssemblyPath>
      <_ProguardProjectConfiguration Condition=" '$(AndroidLinkTool)' != '' ">$(IntermediateOutputPath)proguard\proguard_project_references.cfg</_ProguardProjectConfiguration>
    </PropertyGroup>
    <ItemGroup>
      <!--
        Used for the <ILLink CustomData="@(_TrimmerCustomData)" /> value:
        https://github.com/dotnet/sdk/blob/a5393731b5b7b225692fff121f747fbbc9e8b140/src/Tasks/Microsoft.NET.Build.Tasks/targets/Microsoft.NET.ILLink.targets#L147
        -->
      <_TrimmerCustomData Include="AndroidHttpClientHandlerType" Value="$(AndroidHttpClientHandlerType)" />
      <_TrimmerCustomData Include="AndroidCustomViewMapFile" Value="$(_OuterCustomViewMapFile)" />
      <_TrimmerCustomData
          Condition=" '$(_ProguardProjectConfiguration)' != '' "
          Include="ProguardConfiguration"
          Value="$(_ProguardProjectConfiguration)"
      />
      <_TrimmerCustomData Include="SystemIOHashingAssemblyPath" Value="$(_SystemIOHashingAssemblyPath)" />
      <!-- TypeMap: Output path for LLVM IR generation (JCW is handled by GenerateJavaStubs) -->
      <_TrimmerCustomData Include="LlvmIrOutputPath" Value="$(_TypeMapLlvmIrOutputDir)" />
      <_TrimmerCustomData Include="TargetArch" Value="$(RuntimeIdentifier)" />
      <!-- TypeMap assembly name - the ILLink step reads type mapping info from this assembly -->
      <_TrimmerCustomData Include="TypeMapEntryAssembly" Value="$(TypeMapEntryAssembly)" />

      <!--
        Used for the <ILLink CustomSteps="@(_TrimmerCustomSteps)" /> value:
        https://github.com/dotnet/sdk/blob/a5393731b5b7b225692fff121f747fbbc9e8b140/src/Tasks/Microsoft.NET.Build.Tasks/targets/Microsoft.NET.ILLink.targets#L131
        -->
      <!-- add our custom steps -->
      <!-- Custom MarkHandlers that run during MarkStep -->
      <_TrimmerCustomSteps Include="$(_AndroidLinkerCustomStepAssembly)" Type="Microsoft.Android.Sdk.ILLink.PreserveSubStepDispatcher" />
      <_TrimmerCustomSteps Include="$(_AndroidLinkerCustomStepAssembly)" Type="MonoDroid.Tuner.MarkJavaObjects" />
      <!-- DISABLED: Replaced by TypeMapAttribute unconditional/trimmable preservation strategy
           See type-mapping-api-v3-spec.md for details on how preservation is now handled:
           - JCW types (DoNotGenerateAcw=false) use 2-arg unconditional TypeMapAttribute
           - MCW types (DoNotGenerateAcw=true) use 3-arg trimmable TypeMapAttribute
           - Proxy types directly reference activation ctors, string ctors, and interface methods
      <_TrimmerCustomSteps Include="$(_AndroidLinkerCustomStepAssembly)" Type="MonoDroid.Tuner.PreserveJavaExceptions" />
      <_TrimmerCustomSteps Include="$(_AndroidLinkerCustomStepAssembly)" Type="MonoDroid.Tuner.PreserveApplications" />
      <_TrimmerCustomSteps Include="$(_AndroidLinkerCustomStepAssembly)" Type="Microsoft.Android.Sdk.ILLink.PreserveRegistrations" />
      <_TrimmerCustomSteps Include="$(_AndroidLinkerCustomStepAssembly)" Type="Microsoft.Android.Sdk.ILLink.PreserveJavaInterfaces" />
      -->
      <_TrimmerCustomSteps Include="$(_AndroidLinkerCustomStepAssembly)" Type="MonoDroid.Tuner.FixAbstractMethodsStep" />
      <!-- Custom steps that run after MarkStep -->
      <_TrimmerCustomSteps
          Condition=" '$(_ProguardProjectConfiguration)' != '' "
          Include="$(_AndroidLinkerCustomStepAssembly)"
          AfterStep="CleanStep"
          Type="Mono.Linker.Steps.GenerateProguardConfiguration"
      />
      <_TrimmerCustomSteps
          Condition=" '$(AndroidAddKeepAlives)' == 'true' "
          Include="$(_AndroidLinkerCustomStepAssembly)"
          AfterStep="CleanStep"
          Type="MonoDroid.Tuner.AddKeepAlivesStep"
      />
      <!-- Custom steps that run after CleanStep -->
      <_TrimmerCustomSteps Include="$(_AndroidLinkerCustomStepAssembly)" AfterStep="CleanStep" Type="MonoDroid.Tuner.StripEmbeddedLibraries" />
      <_TrimmerCustomSteps
          Condition=" '$(AndroidLinkResources)' == 'true' "
          Include="$(_AndroidLinkerCustomStepAssembly)"
          AfterStep="CleanStep"
          Type="MonoDroid.Tuner.RemoveResourceDesignerStep"
      />
      <_TrimmerCustomSteps
          Condition=" '$(AndroidLinkResources)' == 'true' "
          Include="$(_AndroidLinkerCustomStepAssembly)"
          AfterStep="CleanStep"
          Type="MonoDroid.Tuner.GetAssembliesStep"
      />
      <_TrimmerCustomSteps
          Condition=" '$(AndroidUseDesignerAssembly)' == 'true' "
          Include="$(_AndroidLinkerCustomStepAssembly)"
          BeforeStep="MarkStep"
          Type="MonoDroid.Tuner.FixLegacyResourceDesignerStep"
      />

      <TrimmerRootDescriptor Include="$(MSBuildThisFileDirectory)..\PreserveLists\*.xml" />
      <TrimmerRootDescriptor Include="@(LinkDescription)" />
      <TrimmerRootAssembly Include="Microsoft.Android.Runtime.NativeAOT" Condition=" '$(_AndroidRuntime)' == 'NativeAOT' " RootMode="All" />
    </ItemGroup>
  </Target>

  <Target Name="_FixRootAssembly" AfterTargets="PrepareForILLink">
    <ItemGroup>
      <TrimmerRootAssembly Update="@(TrimmerRootAssembly)" Condition=" '%(RootMode)' == 'EntryPoint' " RootMode="All" />
    </ItemGroup>
  </Target>

  <Target Name="_LinkAssemblies"
      DependsOnTargets="_ResolveAssemblies;_CreatePackageWorkspace;$(_BeforeLinkAssemblies);_GenerateJniMarshalMethods;_LinkAssembliesNoShrink"
  />

  <Target Name="_TouchAndroidLinkFlag"
      AfterTargets="ILLink"
      Condition=" '$(PublishTrimmed)' == 'true' and Exists('$(_LinkSemaphore)') "
      Inputs="$(_LinkSemaphore)"
      Outputs="$(_AndroidLinkFlag)">
    <!-- This file is an input for _RemoveRegisterAttribute -->
    <Touch Files="$(_AndroidLinkFlag)" AlwaysCreate="true" />
  </Target>

  <!-- After ILLink runs, add the linked TypeMaps assembly to ResolvedFileToPublish.
       ILLink copies the assembly to IntermediateLinkDir, so we need to reference that location. -->
  <Target Name="_AddLinkedTypeMapAssemblyToPublish"
      AfterTargets="ILLink"
      Condition=" '$(PublishTrimmed)' == 'true' and '@(_TypeMapGeneratedAssembly)' != '' ">
    <PropertyGroup>
      <_LinkedTypeMapAssemblyPath>$(IntermediateLinkDir)$([System.IO.Path]::GetFileName('%(_TypeMapGeneratedAssembly.Identity)'))</_LinkedTypeMapAssemblyPath>
    </PropertyGroup>
    <Message Importance="high" Text="DEBUG: Adding linked TypeMaps assembly to ResolvedFileToPublish: $(_LinkedTypeMapAssemblyPath)" />
    <ItemGroup Condition=" Exists('$(_LinkedTypeMapAssemblyPath)') ">
      <ResolvedFileToPublish Include="$(_LinkedTypeMapAssemblyPath)" />
    </ItemGroup>
    <Warning Condition=" !Exists('$(_LinkedTypeMapAssemblyPath)') " 
             Text="TypeMaps assembly not found in linked output: $(_LinkedTypeMapAssemblyPath)" />
  </Target>

  <!-- Collect LLVM IR files generated by GenerateTypeMapAssembly for Type Mapping API marshal methods -->
  <Target Name="_CollectTypeMapMarshalMethodSources">
    <PropertyGroup>
      <_AndroidMarshalMethodsDir>$([System.IO.Path]::Combine('$(IntermediateOutputPath)', 'android'))</_AndroidMarshalMethodsDir>
      <!-- Map RuntimeIdentifier to Android ABI: android-arm64 → arm64-v8a, android-arm → armeabi-v7a, etc. -->
      <_TypeMapMarshalMethodsAbi Condition=" '$(RuntimeIdentifier)' == 'android-arm64' ">arm64-v8a</_TypeMapMarshalMethodsAbi>
      <_TypeMapMarshalMethodsAbi Condition=" '$(RuntimeIdentifier)' == 'android-arm' ">armeabi-v7a</_TypeMapMarshalMethodsAbi>
      <_TypeMapMarshalMethodsAbi Condition=" '$(RuntimeIdentifier)' == 'android-x64' ">x86_64</_TypeMapMarshalMethodsAbi>
      <_TypeMapMarshalMethodsAbi Condition=" '$(RuntimeIdentifier)' == 'android-x86' ">x86</_TypeMapMarshalMethodsAbi>
    </PropertyGroup>
    <ItemGroup Condition=" '$(PublishTrimmed)' == 'true' and '$(_AndroidRuntime)' != 'MonoVM' ">
      <!-- Find all marshal_methods_*.ll files generated by the TypeMap task -->
      <!-- Filter out legacy ILLink typemap init (we generate init ourselves in GenerateTypeMapAssembly) -->
      <_TypeMapMarshalMethodsSource Include="$(_AndroidMarshalMethodsDir)$([System.IO.Path]::DirectorySeparatorChar)marshal_methods_*.ll"
                                     Exclude="$(_AndroidMarshalMethodsDir)$([System.IO.Path]::DirectorySeparatorChar)marshal_methods_typemap.ll">
        <abi>$(_TypeMapMarshalMethodsAbi)</abi>
      </_TypeMapMarshalMethodsSource>
      <!-- Ensure the legacy obj is not passed to native compilation -->
      <AndroidNativeLibrary Remove="$(_AndroidMarshalMethodsDir)$([System.IO.Path]::DirectorySeparatorChar)marshal_methods_typemap.o" />
      <AndroidNativeSource Remove="$(_AndroidMarshalMethodsDir)$([System.IO.Path]::DirectorySeparatorChar)marshal_methods_typemap.ll" />
    </ItemGroup>
  </Target>

  <Target Name="_RemoveLegacyTypemapMarshalMethods"
          BeforeTargets="_CompileNativeAssemblySources"
          Condition=" '$(PublishTrimmed)' == 'true' and '$(_AndroidRuntime)' != 'MonoVM' ">
    <PropertyGroup>
      <_AndroidMarshalMethodsDir>$([System.IO.Path]::Combine('$(IntermediateOutputPath)', 'android'))</_AndroidMarshalMethodsDir>
    </PropertyGroup>
    <ItemGroup>
      <AndroidNativeSource Remove="$(_AndroidMarshalMethodsDir)$([System.IO.Path]::DirectorySeparatorChar)marshal_methods_typemap.ll" />
      <AndroidNativeLibrary Remove="$(_AndroidMarshalMethodsDir)$([System.IO.Path]::DirectorySeparatorChar)marshal_methods_typemap.o" />
    </ItemGroup>
    <Delete Files="$(_AndroidMarshalMethodsDir)$([System.IO.Path]::DirectorySeparatorChar)marshal_methods_typemap.ll" ContinueOnError="true" />
    <Delete Files="$(_AndroidMarshalMethodsDir)$([System.IO.Path]::DirectorySeparatorChar)marshal_methods_typemap.o" ContinueOnError="true" />
  </Target>

</Project>
