<!--
***********************************************************************************************
Microsoft.Android.Sdk.Bindings.Gradle.targets

This file contains MSBuild targets that support building and operating on Android Gradle projects.

***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask TaskName="Xamarin.Android.Tasks.Gradle"              AssemblyFile="Xamarin.Android.Build.Tasks.dll" />

  <PropertyGroup>
    <_BuildAndroidGradleProjectsStamp>$(_AndroidStampDirectory)_BuildAndroidGradleProjects.stamp</_BuildAndroidGradleProjectsStamp>
    <_AGPOutputCacheFile>agpoutputs.cache</_AGPOutputCacheFile>
  </PropertyGroup>

  <ItemDefinitionGroup>
    <AndroidGradleProjectReference>
      <Bind>true</Bind>
      <Configuration>Release</Configuration>
      <ModuleName></ModuleName>
      <OutputPath>$(MSBuildProjectDirectory)/$(IntermediateOutputPath)gradle/%(Filename)/</OutputPath>
      <Pack>true</Pack>
      <ReferenceLibraryOutputs>true</ReferenceLibraryOutputs>
      <Visible>false</Visible>
    </AndroidGradleProjectReference>
  </ItemDefinitionGroup>

  <Target Name="_GetBuildAndroidGradleProjectsInputs"
        Condition=" '@(AndroidGradleProjectReference->Count())' != '0' ">
    <ItemGroup>
      <_AllGradleFiles Include="$([System.IO.Directory]::GetFiles('%(AndroidGradleProjectReference.FullPath)', '*.*', System.IO.SearchOption.AllDirectories))"
          Condition= " Exists('%(AndroidGradleProjectReference.FullPath)') "/>
      <_GradleInputs Include="@(_AllGradleFiles)"
          Condition="  '%(Extension)' == '.java'
                    or '%(Extension)' == '.kt'
                    or '%(Extension)' == '.kts'
                    or '%(Extension)' == '.gradle'
                    or '%(Extension)' == '.properties'
                    or '%(Extension)' == '.xml' " />
      <_GradleInputs Include="$(MSBuildProjectFullPath)" />
      <_GradleInputs Include="@(_AndroidMSBuildAllProjects)" />
    </ItemGroup>
  </Target>

  <Target Name="BuildAndroidGradleProjects"
      Condition=" '@(AndroidGradleProjectReference->Count())' != '0' "
      DependsOnTargets="_SetupMSBuildAllProjects;AndroidPrepareForBuild;_GetBuildAndroidGradleProjectsInputs"
      Inputs="@(_GradleInputs)"
      Outputs="$(_BuildAndroidGradleProjectsStamp)" >
    <!-- Delete outputs folder if inputs have changed to force a partial rebuild -->
    <RemoveDir Directories="@(AndroidGradleProjectReference->'%(OutputPath)outputs')" />

    <!-- Run assemble task for project outputs, android app and library project outputs are currently supported -->
    <Gradle ToolPath="%(AndroidGradleProjectReference.FullPath)"
        Command="assemble%(AndroidGradleProjectReference.Configuration)"
        ModuleName="%(AndroidGradleProjectReference.ModuleName)"
        OutputPath="%(AndroidGradleProjectReference.OutputPath)"
        IntermediateOutputPath="$(MSBuildProjectDirectory)/$(IntermediateOutputPath)"
        AndroidSdkDirectory="$(AndroidSdkDirectory)"
        JavaSdkDirectory="$(JavaSdkDirectory)" >
    </Gradle>

    <ItemGroup>
      <_AndroidGradleProjectAppOutputs      Include="%(AndroidGradleProjectReference.OutputPath)outputs/**/*.apk" />
      <_AndroidGradleProjectLibraryOutputs  Include="%(AndroidGradleProjectReference.OutputPath)outputs/**/*.aar"
          Condition=" '%(ReferenceLibraryOutputs)' == true"
          Bind="%(Bind)"
          Pack="%(Pack)"
          Visible="%(Visible)" />
    </ItemGroup>

    <AndroidMessage ResourceName="XAGRDLRefLibraryOutputs"
        FormatArguments="%(_AndroidGradleProjectLibraryOutputs.FullPath)"
        Condition=" '@(_AndroidGradleProjectLibraryOutputs->Count())' != '0' "
    />

    <Touch Files="$(_BuildAndroidGradleProjectsStamp)" AlwaysCreate="True" />
    <ItemGroup>
      <FileWrites Include="$(_BuildAndroidGradleProjectsStamp);%(AndroidGradleProjectReference.OutputPath)**/*" />
      <!-- Copy app output files to $(OutputPath) -->
      <None Include="@(_AndroidGradleProjectAppOutputs)" CopyToOutputDirectory="PreserveNewest" Link="%(Filename)%(Extension)" />
      <!-- Automatically add library outputs to be bound or otherwise processed later in the build -->
      <AndroidLibrary Include="@(_AndroidGradleProjectLibraryOutputs)" Bind="%(Bind)" Pack="%(Pack)" Visible="%(Visible)" />
    </ItemGroup>
  </Target>

  <Target Name="CleanAndroidGradleProjects"
      Condition=" '@(AndroidGradleProjectReference->Count())' != '0' " >
    <Gradle ToolPath="%(AndroidGradleProjectReference.FullPath)"
        Command="clean"
        ModuleName="%(AndroidGradleProjectReference.ModuleName)"
        OutputPath="%(AndroidGradleProjectReference.OutputPath)"
        IntermediateOutputPath="$(MSBuildProjectDirectory)/$(IntermediateOutputPath)"
        AndroidSdkDirectory="$(AndroidSdkDirectory)"
        JavaSdkDirectory="$(JavaSdkDirectory)" >
    </Gradle>
  </Target>

</Project>
