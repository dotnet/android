<!--
***********************************************************************************************
Microsoft.Android.Sdk.Bindings.Gradle.targets

This file contains MSBuild targets that support building and operating on Android Gradle projects.

***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask TaskName="Xamarin.Android.Tasks.Gradle"              AssemblyFile="Xamarin.Android.Build.Tasks.dll" />

  <PropertyGroup>
    <_BuildAndroidGradleProjectsStamp>$(_AndroidStampDirectory)_BuildAndroidGradleProjects.stamp</_BuildAndroidGradleProjectsStamp>
  </PropertyGroup>

  <ItemDefinitionGroup>
    <AndroidGradleProjectReference>
      <Bind>true</Bind>
      <Configuration>Release</Configuration>
      <ModuleName></ModuleName>
      <OutputPath>$(MSBuildProjectDirectory)/$(IntermediateOutputPath)gradle/%(Filename)/</OutputPath>
      <Pack>true</Pack>
      <ReferenceLibraryOutputs>true</ReferenceLibraryOutputs>
      <Visible>false</Visible>
    </AndroidGradleProjectReference>
  </ItemDefinitionGroup>

  <Target Name="_GetBuildAndroidGradleProjectsInputs"
        Condition=" '@(AndroidGradleProjectReference->Count())' != '0' ">
    <ItemGroup>
      <_AllGradleFiles Include="$([System.IO.Directory]::GetFiles('%(AndroidGradleProjectReference.FullPath)', '*.*', System.IO.SearchOption.AllDirectories))"
          Condition= " Exists('%(AndroidGradleProjectReference.FullPath)') "/>
      <_GradleInputs Include="@(_AllGradleFiles)"
          Condition="  '%(Extension)' == '.java'
                    or '%(Extension)' == '.kt'
                    or '%(Extension)' == '.kts'
                    or '%(Extension)' == '.gradle'
                    or '%(Extension)' == '.properties'
                    or '%(Extension)' == '.xml' " />
      <_GradleInputs Include="$(MSBuildProjectFullPath)" />
      <_GradleInputs Include="@(_AndroidMSBuildAllProjects)" />
    </ItemGroup>
  </Target>

  <Target Name="BuildAndroidGradleProjects"
      Condition=" '@(AndroidGradleProjectReference->Count())' != '0' "
      DependsOnTargets="_SetupMSBuildAllProjects;AndroidPrepareForBuild;_GetBuildAndroidGradleProjectsInputs"
      Inputs="@(_GradleInputs)"
      Outputs="$(_BuildAndroidGradleProjectsStamp)" >
    <!-- Delete outputs folder if inputs have changed to force a partial rebuild -->
    <RemoveDir Directories="@(AndroidGradleProjectReference->'%(OutputPath)outputs')" />

    <!-- Run assemble task for project outputs, android app and library project outputs are currently supported -->
    <Gradle ToolPath="%(AndroidGradleProjectReference.FullPath)"
        Command="assemble%(AndroidGradleProjectReference.Configuration)"
        ModuleName="%(AndroidGradleProjectReference.ModuleName)"
        OutputPath="%(AndroidGradleProjectReference.OutputPath)"
        IntermediateOutputPath="$(MSBuildProjectDirectory)/$(IntermediateOutputPath)"
        ReferenceLibraryOutputs="%(AndroidGradleProjectReference.ReferenceLibraryOutputs)"
        AndroidSdkDirectory="$(AndroidSdkDirectory)"
        JavaSdkDirectory="$(JavaSdkDirectory)" >
      <Output TaskParameter="AppOutputs" ItemName="_AndroidGradleProjectAppOutputs" />
      <Output TaskParameter="LibraryOutputs" ItemName="_AndroidGradleProjectLibraryOutputs" />
    </Gradle>

    <WriteLinesToFile
        File="%(AndroidGradleProjectReference.OutputPath)libraryoutputs.txt"
        Lines="@(_AndroidGradleProjectLibraryOutputs)"
        Overwrite="true"
        WriteOnlyWhenDifferent="true"
        Condition=" '@(_AndroidGradleProjectLibraryOutputs->Count())' != '0' "
    />

    <Touch Files="$(_BuildAndroidGradleProjectsStamp)" AlwaysCreate="True" />
    <ItemGroup>
      <FileWrites Include="$(_BuildAndroidGradleProjectsStamp);%(AndroidGradleProjectReference.OutputPath)**/*" />
      <!-- Copy app output files to $(OutputPath) -->
      <None Include="@(_AndroidGradleProjectAppOutputs)" CopyToOutputDirectory="PreserveNewest" Link="%(Filename)%(Extension)" />
    </ItemGroup>
  </Target>

  <!-- Automatically add library outputs to be bound or otherwise processed later in the build
        This is done in a separate target to ensure @(AndroidLibrary) items are added even when BuildAndroidGradleProjects is skipped -->
  <Target Name="_IncludeAndroidGradleProjectsOutputs"
      AfterTargets="BuildAndroidGradleProjects"
      Condition=" '@(AndroidGradleProjectReference->Count())' != '0' ">
    <ReadLinesFromFile File="%(AndroidGradleProjectReference.OutputPath)libraryoutputs.txt" >
      <Output TaskParameter="Lines" ItemName="_AndroidGradleProjectLibraryOutputs"/>
    </ReadLinesFromFile>
    <ItemGroup>
      <AndroidLibrary Include="@(_AndroidGradleProjectLibraryOutputs)" Condition=" '%(AndroidGradleProjectReference.ReferenceLibraryOutputs)' == 'true' ">
        <Bind>%(AndroidGradleProjectReference.Bind)</Bind>
        <Pack>%(AndroidGradleProjectReference.Pack)</Pack>
        <Visible>%(AndroidGradleProjectReference.Visible)</Visible>
      </AndroidLibrary>
    </ItemGroup>
  </Target>

  <Target Name="CleanAndroidGradleProjects"
      Condition=" '@(AndroidGradleProjectReference->Count())' != '0' " >
    <Gradle ToolPath="%(AndroidGradleProjectReference.FullPath)"
        Command="clean"
        ModuleName="%(AndroidGradleProjectReference.ModuleName)"
        OutputPath="%(AndroidGradleProjectReference.OutputPath)"
        IntermediateOutputPath="$(MSBuildProjectDirectory)/$(IntermediateOutputPath)"
        AndroidSdkDirectory="$(AndroidSdkDirectory)"
        JavaSdkDirectory="$(JavaSdkDirectory)" >
    </Gradle>
  </Target>

</Project>
