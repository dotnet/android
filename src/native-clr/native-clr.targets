<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask AssemblyFile="$(BootstrapTasksAssembly)" TaskName="Xamarin.Android.Tools.BootstrapTasks.RunParallelCmds" />
  <Target Name="_BuildRuntimes" BeforeTargets="Build"
          DependsOnTargets="_ConfigureRuntimes;_BuildAndroidRuntimes;_CopyToPackDirs">
  </Target>

  <Target Name="_TestPinvokeTables" Condition=" '$(HostOS)' == 'Linux' And '$(RunningOnCI)' == 'true' ">
    <Exec
        Command="..\..\build-tools\scripts\generate-pinvoke-tables.sh --test-only --ci"
        WorkingDirectory="$(MSBuildThisFileDirectory)"
    />
  </Target>

  <Target Name="_ConfigureRuntimesInputs">
    <ItemGroup>
      <_ConfigureRuntimesInputs  Include="CMakeLists.txt" />
      <_ConfigureRuntimesInputs  Include="java-interop\CMakeLists.txt" />
      <_ConfigureRuntimesInputs  Include="lz4\CMakeLists.txt" />
      <_ConfigureRuntimesInputs  Include="..\..\build-tools\scripts\Ndk.targets" />
      <_ConfigureRuntimesOutputs Include="@(AndroidSupportedTargetJitAbi->'$(IntermediateOutputPath)\%(AndroidRID)-clr-Debug\CMakeCache.txt')" />
      <_ConfigureRuntimesOutputs Include="@(AndroidSupportedTargetJitAbi->'$(IntermediateOutputPath)\%(AndroidRID)-clr-Release\CMakeCache.txt')" />
      <_OutputDirsToCreate       Include="$(IntermediateOutputPath)%(AndroidSupportedTargetJitAbi.AndroidRID)-clr-Debug" />
      <_OutputDirsToCreate       Include="$(IntermediateOutputPath)%(AndroidSupportedTargetJitAbi.AndroidRID)-clr-Release" />
    </ItemGroup>
  </Target>

  <Target Name="_ConfigureRuntimes"
          DependsOnTargets="_ConfigureRuntimesInputs"
          Inputs="@(_ConfigureRuntimesInputs)"
          Outputs="@(_ConfigureRuntimesOutputs)">
    <PropertyGroup>
      <_NoInline Condition=" '$(DoNotInlineMonodroid)' == 'true' ">-DDONT_INLINE=ON</_NoInline>
      <_NoStrip Condition=" '$(DoNotStripMonodroid)' == 'true' ">-DSTRIP_DEBUG=OFF</_NoStrip>

      <_CmakeAndroidFlags>$(_NoInline) $(_NoStrip) "$(MSBuildThisFileDirectory)"</_CmakeAndroidFlags>
    </PropertyGroup>

    <ItemGroup>
      <_ConfigureRuntimeCommands Include="@(AndroidSupportedTargetJitAbi)">
        <Command>$(CmakePath)</Command>
        <Arguments>--preset default-debug-%(AndroidSupportedTargetJitAbi.Identity) $(_CmakeAndroidFlags)</Arguments>
        <WorkingDirectory>$(IntermediateOutputPath)%(AndroidSupportedTargetJitAbi.AndroidRID)-clr-Debug</WorkingDirectory>
      </_ConfigureRuntimeCommands>

      <_ConfigureRuntimeCommands Include="@(AndroidSupportedTargetJitAbi)">
        <Command>$(CmakePath)</Command>
        <Arguments>--preset default-release-%(AndroidSupportedTargetJitAbi.Identity) $(_CmakeAndroidFlags)</Arguments>
        <WorkingDirectory>$(IntermediateOutputPath)%(AndroidSupportedTargetJitAbi.AndroidRID)-clr-Release</WorkingDirectory>
      </_ConfigureRuntimeCommands>
    </ItemGroup>

    <MakeDir Directories="@(_OutputDirsToCreate)"/>
    <RunParallelCmds Commands="@(_ConfigureRuntimeCommands)" />
    <Touch Files="@(_ConfigureRuntimesOutputs)" />
  </Target>

  <!-- TODO: update for the changes -->
  <Target Name="_FindMonoDroidSources">
    <ItemGroup>
      <_MonoDroidSources Include="$(JavaInteropFullPath)\src\java-interop\*.cc;$(JavaInteropFullPath)\src\java-interop\*.h" />
      <_MonoDroidSources Include="$(LZ4SourceFullPath)\lib\lz4.c;$(LZ4SourceFullPath)\lib\lz4.h" />
    </ItemGroup>
  </Target>

  <Target Name="_BuildAndroidRuntimesInputs"
          DependsOnTargets="_FindMonoDroidSources">
    <ItemGroup>
      <_BuildAndroidRuntimesInputs  Include="@(AndroidSupportedTargetJitAbi->'$(IntermediateOutputPath)\%(AndroidRID)-clr-Debug\CMakeCache.txt')" />
      <_BuildAndroidRuntimesInputs  Include="@(AndroidSupportedTargetJitAbi->'$(IntermediateOutputPath)\%(AndroidRID)-clr-Release\CMakeCache.txt')" />
      <_BuildAndroidRuntimesInputs  Include="@(_MonoDroidSources)" />
      <_BuildAndroidRuntimesInputs  Include="..\..\build-tools\scripts\Ndk.targets" />
      <_BuildAndroidRuntimesOutputs Include="@(AndroidSupportedTargetJitAbi->'$(OutputPath)\%(AndroidRID)\libnet-android.debug.so')" />
      <_BuildAndroidRuntimesOutputs Include="@(AndroidSupportedTargetJitAbi->'$(OutputPath)\%(AndroidRID)\libnet-android.release.so')" />
      <_BuildAndroidRuntimesOutputs Include="@(AndroidSupportedTargetJitAbi->'$(OutputPath)\%(AndroidRID)\Debug\libxamarin-app-clr.so')" />
      <_BuildAndroidRuntimesOutputs Include="@(AndroidSupportedTargetJitAbi->'$(OutputPath)\%(AndroidRID)\Release\libxamarin-app-clr.so')" />
    </ItemGroup>
  </Target>

  <Target Name="_BuildAndroidRuntimes"
          DependsOnTargets="_BuildAndroidRuntimesInputs;_TestPinvokeTables"
          Inputs="@(_BuildAndroidRuntimesInputs)"
          Outputs="@(_BuildAndroidRuntimesOutputs)">
    <Exec
        Command="$(NinjaPath) -v"
        WorkingDirectory="$(IntermediateOutputPath)%(AndroidSupportedTargetJitAbi.AndroidRID)-clr-Debug" />

    <Exec
        Command="$(NinjaPath) -v"
        WorkingDirectory="$(IntermediateOutputPath)%(AndroidSupportedTargetJitAbi.AndroidRID)-clr-Release" />

    <Touch Files="@(_BuildAndroidRuntimesOutputs)" />
  </Target>

  <Target Name="_CleanRuntimes"
      AfterTargets="Clean">
    <Exec
        Command="$(NinjaPath) -v clean"
        WorkingDirectory="$(IntermediateOutputPath)%(AndroidSupportedTargetJitAbi.AndroidRID)-clr-Debug"/>
    <Exec
        Command="$(NinjaPath) -v clean"
        WorkingDirectory="$(IntermediateOutputPath)%(AndroidSupportedTargetJitAbi.AndroidRID)-clr-Release"/>

    <RemoveDir Directories="obj\local;libs" />
    <RemoveDir Directories="$(IntermediateOutputPath)%(AndroidSupportedTargetJitAbi.AndroidRID)-clr-Debug" />
    <RemoveDir Directories="$(IntermediateOutputPath)%(AndroidSupportedTargetJitAbi.AndroidRID)-clr-Release" />
    <Delete Files="jni\config.include;jni\machine.config.include;jni\Application.mk" />
    <Delete Files="@(AndroidSupportedTargetJitAbi->'$(OutputPath)\%(AndroidRID)\libnet-android.debug.so')" />
    <Delete Files="@(AndroidSupportedTargetJitAbi->'$(OutputPath)\%(AndroidRID)\libnet-android.debug.d.so')" />
    <Delete Files="@(AndroidSupportedTargetJitAbi->'$(OutputPath)\%(AndroidRID)\libnet-android.release.so')" />
    <Delete Files="@(AndroidSupportedTargetJitAbi->'$(OutputPath)\%(AndroidRID)\libnet-android.release.d.so')" />
    <Delete Files="%(_EmbeddedBlob.Include)" />
  </Target>

  <Target Name="CoreCompile"
          DependsOnTargets="Build">
  </Target>

  <Target Name="_CopyToPackDirs">
    <ItemGroup>
      <_ArmRuntimePackFiles   Include="$(OutputPath)\android-arm\*.*" />
      <_Arm64RuntimePackFiles Include="$(OutputPath)\android-arm64\*.*" />
      <_x86RuntimePackFiles   Include="$(OutputPath)\android-x86\*.*" />
      <_x64RuntimePackFiles   Include="$(OutputPath)\android-x64\*.*" />
    </ItemGroup>

    <Copy
        SourceFiles="@(_ArmRuntimePackFiles)"
        DestinationFolder="$(MicrosoftAndroidArmPackDir)native"
        SkipUnchangedFiles="true" />
    <Copy
        SourceFiles="@(_Arm64RuntimePackFiles)"
        DestinationFolder="$(MicrosoftAndroidArm64PackDir)native"
        SkipUnchangedFiles="true" />
    <Copy
        SourceFiles="@(_x86RuntimePackFiles)"
        DestinationFolder="$(MicrosoftAndroidx86PackDir)native"
        SkipUnchangedFiles="true" />
    <Copy
        SourceFiles="@(_x64RuntimePackFiles)"
        DestinationFolder="$(MicrosoftAndroidx64PackDir)native"
        SkipUnchangedFiles="true" />
  </Target>
</Project>
