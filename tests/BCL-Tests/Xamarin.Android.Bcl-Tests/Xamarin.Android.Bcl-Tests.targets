<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask AssemblyFile="..\..\..\bin\Build$(Configuration)\xa-prep-tasks.dll"   TaskName="Xamarin.Android.BuildTools.PrepTasks.ReplaceFileContents" />
  <UsingTask AssemblyFile="..\..\..\bin\Build$(Configuration)\xa-prep-tasks.dll"   TaskName="Xamarin.Android.BuildTools.PrepTasks.SystemUnzip" />
  <Import Project="Xamarin.Android.Bcl-Tests.projitems" />
  <Import Project="..\..\..\build-tools\scripts\TestApks.targets" />
  <Import Project="..\..\..\src\mono-runtimes\ProfileAssemblies.projitems" />
  <Target Name="_GetTestAssemblies">
    <ItemGroup>
      <_TestAssembly Include="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_*_test.dll">
        <!-- This is needed for the remaping from nunitlite to Xamarin.Android.NUnitLite -->
        <TestType>nunit</TestType>
      </_TestAssembly>
      <_TestAssembly Include="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_*_xunit-test.dll" />
      <!-- This is referenced by monodroid_corlib_xunit-test.dll -->
      <_TestAssembly Include="..\..\..\bin\$(Configuration)\bcl-tests\System.Runtime.CompilerServices.Unsafe.dll" />
    </ItemGroup>
    <ItemGroup>
      <!-- These NUnit tests are disabled for now. We need to check if they are working -->
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_I18N.Other_test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_I18N.Rare_test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_Mono.Posix_test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.ComponentModel.DataAnnotations_test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.Security_test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.ServiceModel_test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.Web.Services_test.dll" />
    </ItemGroup>
    <ItemGroup>
      <!-- These XUnit tests are disabled for now. We need to check if they are working -->
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_Microsoft.CSharp_xunit-test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System_xunit-test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.ComponentModel.Composition_xunit-test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.Core_xunit-test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.Data_xunit-test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.Json_xunit-test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.Runtime.CompilerServices.Unsafe_xunit-test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.Runtime.Serialization_xunit-test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.Security_xunit-test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.Xml_xunit-test.dll" />
      <_TestAssembly Remove="..\..\..\bin\$(Configuration)\bcl-tests\monodroid_System.Xml.Linq_xunit-test.dll" />
    </ItemGroup>
  </Target>
  <Target Name="_AddTestAssemblies"
      DependsOnTargets="_GetTestAssemblies;_RemapAssemblies"
      BeforeTargets="ResolveAssemblyReferences">
    <ItemGroup>
      <Reference Include="@(_TestAssembly->'$(IntermediateOutputPath)%(RecursiveDir)%(Filename)%(Extension)')" />
    </ItemGroup>
  </Target>
  <Target Name="_RemapAssemblies"
      DependsOnTargets="_GetTestAssemblies"
      Inputs="@(_TestAssembly)"
      Outputs="@(_TestAssembly->'$(IntermediateOutputPath)%(RecursiveDir)%(Filename)%(Extension)')">
    <MakeDir Directories="$(IntermediateOutputPath)" />
    <ResolveAssemblyReference
        Assemblies="Xamarin.Android.NUnitLite"
        SearchPaths="$(XAInstallPrefix)xbuild-frameworks\MonoAndroid\v1.0;$(FrameworkPathOverride)">
      <Output TaskParameter="ResolvedFiles"   PropertyName="_NUnit" />
    </ResolveAssemblyReference>
    <Exec
        Condition=" '%(_TestAssembly.TestType)' == 'nunit' "
        Command="$(RemapAssemblyRefTool) &quot;%(_TestAssembly.Identity)&quot; &quot;$(IntermediateOutputPath)%(_TestAssembly.RecursiveDir)%(_TestAssembly.Filename)%(_TestAssembly.Extension)&quot; nunitlite &quot;$(_NUnit)&quot;"
    />
    <Copy
        Condition=" '%(_TestAssembly.TestType)' == '' "
        SourceFiles="@(_TestAssembly->'..\..\..\bin\$(Configuration)\bcl-tests\%(RecursiveDir)%(Filename)%(Extension)')"
        DestinationFiles="@(_TestAssembly->'$(IntermediateOutputPath)%(RecursiveDir)%(Filename)%(Extension)')"
    />
    <Copy
        Condition="Exists('..\..\..\bin\$(Configuration)\bcl-tests\%(_TestAssembly.RecursiveDir)%(_TestAssembly.Filename).pdb')"
        SourceFiles="@(_TestAssembly->'..\..\..\bin\$(Configuration)\bcl-tests\%(RecursiveDir)%(Filename).pdb')"
        DestinationFiles="@(_TestAssembly->'$(IntermediateOutputPath)%(RecursiveDir)%(Filename).pdb')"
    />
  </Target>
  <Target Name="_WriteAssembliesList"
      Outputs="nunit-assemblies.txt;xunit-assemblies.txt"
      BeforeTargets="CoreCompile">
    <WriteLinestoFile
        File="nunit-assemblies.txt"
        Lines="@(_TestAssembly->'%(Filename)%(Extension)')"
        Condition=" '%(_TestAssembly.TestType)' == 'nunit' "
        WriteOnlyWhenDifferent="True"
        Overwrite="True"
    />
    <WriteLinestoFile
        File="xunit-assemblies.txt"
        Lines="@(_TestAssembly->'%(Filename)%(Extension)')"
        Condition=" '%(_TestAssembly.TestType)' == '' "
        WriteOnlyWhenDifferent="True"
        Overwrite="True"
    />
  </Target>
</Project>
