<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="..\..\Configuration.props" />
  <Import Project="android-toolchain.projitems" />
  <Target Name="_CopyBootstrapTasksAssembly"
      Outputs="$(OutputPath)\Xamarin.Android.Tools.BootstrapTasks.dll">
    <MSBuild
        Projects="..\..\src\Xamarin.Android.Tools.BootstrapTasks\Xamarin.Android.Tools.BootstrapTasks.csproj"
        Properties="OutputPath=$(AndroidToolchainDirectory)"
    />
  </Target>
  <UsingTask AssemblyFile="$(OutputPath)\Xamarin.Android.Tools.BootstrapTasks.dll" TaskName="Xamarin.Android.Tools.BootstrapTasks.CreateTemporaryDirectory" />
  <UsingTask AssemblyFile="$(OutputPath)\Xamarin.Android.Tools.BootstrapTasks.dll" TaskName="Xamarin.Android.Tools.BootstrapTasks.DownloadUri" />
  <UsingTask AssemblyFile="$(OutputPath)\Xamarin.Android.Tools.BootstrapTasks.dll" TaskName="Xamarin.Android.Tools.BootstrapTasks.UnzipDirectoryChildren" />
  <UsingTask AssemblyFile="$(OutputPath)\Xamarin.Android.Tools.BootstrapTasks.dll" TaskName="Xamarin.Android.Tools.BootstrapTasks.Which" />
  <Target Name="_CheckForRequiredPrograms">
    <Which Program="%(_RequiredProgram.Identity)" Required="True" />
    <OnError ExecuteTargets="_PrintRequiredPrograms" />
  </Target>
  <Target Name="_PrintRequiredPrograms">
    <Error
        ContinueOnError="True"
        Text="The following programs are required: @(_RequiredProgram->'%(Identity)', ' ')"
    />
    <Error
        Condition=" '$(HostOS)' == 'Darwin' "
        ContinueOnError="True"
        Text="Please try running: brew install @(_RequiredProgram->'%(Homebrew)', ' ')`"
    />
  </Target>
  <Target Name="_DetermineItems">
    <CreateItem
        Include="@(AndroidSdkItem)"
        Condition=" '%(HostOS)' == '$(HostOS)' Or '%(HostOS)' == '' ">
			<Output TaskParameter="Include" ItemName="_PlatformAndroidSdkItem"/>
    </CreateItem>
    <CreateItem
        Include="@(AndroidNdkItem)"
        Condition=" '%(HostOS)' == '$(HostOS)' Or '%(HostOS)' == '' ">
			<Output TaskParameter="Include" ItemName="_PlatformAndroidNdkItem"/>
    </CreateItem>
    <ItemGroup>
        <_SdkStampFiles Include="@(_PlatformAndroidSdkItem->'$(AndroidToolchainDirectory)\sdk\.stamp-%(Identity)')" />
    </ItemGroup>
  </Target>
  <Target Name="_DownloadItems"
      DependsOnTargets="_DetermineItems"
      Outputs="@(_PlatformAndroidSdkItem->'$(AndroidToolchainCacheDirectory)\%(Identity)');@(_PlatformAndroidNdkItem->'$(AndroidToolchainCacheDirectory)\%(Identity)')">
    <MakeDir Directories="$(AndroidToolchainCacheDirectory)" />
    <DownloadUri
        SourceUris="@(_PlatformAndroidSdkItem->'$(AndroidUri)/%(Identity)');@(_PlatformAndroidNdkItem->'$(AndroidUri)/%(Identity)')"
        DestinationFiles="@(_PlatformAndroidSdkItem->'$(AndroidToolchainCacheDirectory)\%(Identity)');@(_PlatformAndroidNdkItem->'$(AndroidToolchainCacheDirectory)\%(Identity)')"
    />
  </Target>
  <Target Name="_UnzipFiles"
      DependsOnTargets="_DetermineItems"
      Inputs="@(_PlatformAndroidSdkItem->'$(AndroidToolchainCacheDirectory)\%(Identity)')"
      Outputs="@(_SdkStampFiles);$(AndroidToolchainDirectory)\ndk\.stamp-ndk">
    <CreateItem
        Include="@(_PlatformAndroidSdkItem->'$(AndroidToolchainCacheDirectory)\%(_PlatformAndroidSdkItem.Identity)">
      <Output TaskParameter="Include" ItemName="_AndroidSdkItems"/>
    </CreateItem>
    <CreateItem
        Include="@(_PlatformAndroidNdkItem->'$(AndroidToolchainCacheDirectory)\%(_PlatformAndroidNdkItem.Identity)"
        Condition=" '%(HostOS)' == '$(HostOS)' Or '%(HostOS)' == '' ">
      <Output TaskParameter="Include" ItemName="_AndroidNdkItems"/>
    </CreateItem>

    <RemoveDir Directories="$(AndroidToolchainDirectory)\sdk;$(AndroidToolchainDirectory)\ndk" />
    <MakeDir Directories="$(AndroidToolchainDirectory)\sdk;$(AndroidToolchainDirectory)\ndk" />

    <UnzipDirectoryChildren
        HostOS="$(HostOS)"
        SourceFiles="@(AndroidSdkItem->'$(AndroidToolchainCacheDirectory)\%(Identity)')"
        DestinationFolder="$(AndroidToolchainDirectory)\sdk"
    />
    <UnzipDirectoryChildren
        HostOS="$(HostOS)"
        SourceFiles="@(AndroidNdkItem->'$(AndroidToolchainCacheDirectory)\%(Identity)')"
        DestinationFolder="$(AndroidToolchainDirectory)\ndk"
    />
    <Touch
        Files="@(_SdkStampFiles);$(AndroidToolchainDirectory)\ndk\.stamp-ndk"
        AlwaysCreate="True"
    />
  </Target>
  <Target Name="_CreateNdkToolchains"
      Condition=" '$(OS)' == 'Unix' "
      Inputs="$(AndroidToolchainDirectory)\ndk\.stamp-ndk"
      Outputs="@(_NdkToolchain->'$(AndroidToolchainDirectory)\toolchains\%(Identity)\AndroidVersion.txt')">
    <PropertyGroup>
      <_Script>$(AndroidToolchainDirectory)\ndk\build\tools\make-standalone-toolchain.sh</_Script>
      <_Install>@(_NdkToolchain->'$(AndroidToolchainDirectory)\toolchains\%(Identity)')</_Install>
      <_Toolchain>@(_NdkToolchain->'%(Identity)')</_Toolchain>
    </PropertyGroup>
    <Exec Command="bash &quot;$(_Script)&quot; --platform=%(_NdkToolchain.Platform) &quot;--install-dir=$(_Install)&quot; --arch=%(_NdkToolchain.Arch) --toolchain=$(_Toolchain)" />
    <Touch
        Files="@(_NdkToolchain->'$(AndroidToolchainDirectory)\toolchains\%(Identity)\AndroidVersion.txt')"
        AlwaysCreate="False"
    />
  </Target>
  <Target Name="_GetAndroidSdkDirectory">
    <Message
        Text="$(AndroidToolchainDirectory)\sdk"
        Importance="High"
    />
  </Target>
  <Target Name="_GetAndroidNdkDirectory">
    <Message
        Text="$(AndroidToolchainDirectory)\ndk"
        Importance="High"
    />
  </Target>
  <Target Name="_SetMxeToolchainMakefileTimeToLastCommitTimestamp"
      Condition="$(AndroidSupportedAbisForConditionalChecks.Contains (',host-win64,')) Or $(AndroidSupportedAbisForConditionalChecks.Contains (',host-win32,'))">
    <Exec
        Command="touch -m -t `git log -1 --format=%25cd --date=format-local:%25Y%25m%25d%25H%25M.%25S` Makefile"
        WorkingDirectory="..\..\external\mxe"
    />
  </Target>
  <Target Name="_CreateMxeW32Toolchain"
      DependsOnTargets="_SetMxeToolchainMakefileTimeToLastCommitTimestamp"
      Condition="$(AndroidSupportedAbisForConditionalChecks.Contains (',host-win64,'))"
      Inputs="..\..\external\mxe\Makefile"
      Outputs="$(AndroidMxeFullPath)\bin\i686-w64-mingw32.static-gcc">
    <Exec
        Command="make $(MAKEFLAGS) MXE_TARGETS=&quot;i686-w64-mingw32.static&quot; gcc PREFIX=&quot;$(AndroidMxeFullPath)&quot;"
        WorkingDirectory="..\..\external\mxe"
    />
  </Target>
  <Target Name="_CreateMxeW64Toolchain"
      DependsOnTargets="_SetMxeToolchainMakefileTimeToLastCommitTimestamp"
      Condition="$(AndroidSupportedAbisForConditionalChecks.Contains (',host-win64,'))"
      Inputs="..\..\external\mxe\Makefile"
      Outputs="$(AndroidMxeFullPath)\bin\x86_64-w64-mingw32.static-gcc">
    <Exec
        Command="make $(MAKEFLAGS) MXE_TARGETS=&quot;x86_64-w64-mingw32.static&quot; gcc PREFIX=&quot;$(AndroidMxeFullPath)&quot;"
        WorkingDirectory="..\..\external\mxe"
    />
  </Target>
  <Target Name="_CreateMxeToolchains"
      DependsOnTargets="_CreateMxeW32Toolchain;_CreateMxeW64Toolchain">
  </Target>
</Project>
