<?xml version="1.0" encoding="utf-8"?>
<Project InitialTargets="_WarnAboutMissingProjitems" DefaultTargets="RunAllTests" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$([MSBuild]::GetPathOfFileAbove('Directory.Build.props'))" />
  <PropertyGroup>
    <_TopDir>$(MSBuildThisFileDirectory)..\..</_TopDir>
  </PropertyGroup>
  <Import Project="$(_TopDir)\Configuration.props" />
  <UsingTask AssemblyFile="$(PrepTasksAssembly)" TaskName="Xamarin.Android.BuildTools.PrepTasks.RunParallelTargets" />
  <UsingTask AssemblyFile="$(PrepTasksAssembly)" TaskName="Xamarin.Android.BuildTools.PrepTasks.SetEnvironmentVariable" />
  <PropertyGroup>
    <_Test Condition=" '$(TEST)' != '' ">--test=&quot;$(TEST)&quot;</_Test>
    <_XABuild>$(_TopDir)\bin\$(Configuration)\bin\xabuild</_XABuild>
    <_XABinLogPrefix>/v:normal /binaryLogger:"$(MSBuildThisFileDirectory)\..\..\bin\Test$(Configuration)\msbuild</_XABinLogPrefix>
    <_XABuildDiag Condition=" '$(USE_MSBUILD)' == '0' And '$(V)' != '' ">/v:diag </_XABuildDiag>
    <_XABuildProperties>$(_XABuildDiag)/p:Configuration=$(Configuration)</_XABuildProperties>
  </PropertyGroup>

  <Import
    Project="$(_TopDir)\bin\Test$(Configuration)\RunTests.HostUnit.projitems"
    Condition="Exists('$(_TopDir)\bin\Test$(Configuration)\RunTests.HostUnit.projitems')" />
  <Import
    Project="$(_TopDir)\bin\Test$(Configuration)\RunTests.APK.projitems"
    Condition="Exists('$(_TopDir)\bin\Test$(Configuration)\RunTests.APK.projitems')" />

  <Target Name="_WarnAboutMissingProjitems">
    <Message
      Text="$(_TopDir)\bin\Test$(Configuration)\RunTests.HostUnit.projitems does not exist"
      Condition="!Exists('$(_TopDir)\bin\Test$(Configuration)\RunTests.HostUnit.projitems')" />

    <Message
      Text="$(_TopDir)\bin\Test$(Configuration)\RunTests.APK.projitems does not exist"
      Condition="!Exists('$(_TopDir)\bin\Test$(Configuration)\RunTests.APK.projitems')" />
  </Target>

  <Target Name="ListNUnitTests">
    <Exec
        Command="$(_NUnit) $(NUNIT_EXTRA) --explore %(_TestAssembly.Identity)"
        WorkingDirectory="$(_TopDir)"
        ContinueOnError="ErrorAndContinue"
    />
  </Target>
  <Target Name="RunNUnitTests">
    <SetEnvironmentVariable Name="USE_MSBUILD" Value="0" Condition=" '$(USE_MSBUILD)' == '' " />
    <ItemGroup>
      <NUnitTarget Include="@(_TestAssembly)">
         <TestFilename>%(_TestAssembly.Filename)</TestFilename>
         <NUnitOutput Condition=" '$(HostOS)' != 'Windows' " >| tee &quot;bin\Test$(Configuration)\TestOutput-%(_TestAssembly.Filename).txt&quot;</NUnitOutput>
         <NUnitOutput Condition=" '$(HostOS)' == 'Windows'  ">--output=&quot;bin\Test$(Configuration)\TestOutput-%(_TestAssembly.Filename).txt&quot;</NUnitOutput>
      </NUnitTarget>
    </ItemGroup>
    <Exec
        Command="$(_NUnit) $(NUNIT_EXTRA) %(NUnitTarget.Identity) $(_Test) --labels=all --result=&quot;TestResult-%(NUnitTarget.TestFilename).xml&quot; %(NUnitTarget.NUnitOutput)"
        WorkingDirectory="$(_TopDir)"
        IgnoreStandardErrorWarningFormat="true"
        ContinueOnError="ErrorAndContinue"
    />
    <ItemGroup>
      <_RenameNUnitTestCasesGlob Include="$(_TopDir)\TestResult-*Tests.xml" />
    </ItemGroup>
    <PropertyGroup>
      <_RenamedTestCases>@(_RenameNUnitTestCasesGlob)</_RenamedTestCases>
    </PropertyGroup>
    <MSBuild
        ContinueOnError="ErrorAndContinue"
        Projects="$(MSBuildThisFileDirectory)TestApks.targets"
        Targets="RenameTestCases"
        Properties="Configuration=$(Configuration);RenameTestCasesGlob=$(_RenamedTestCases);BootstrapTasksAssembly=$(BootstrapTasksAssembly);PrepTasksAssembly=$(PrepTasksAssembly)"
    />
  </Target>
  <Target Name="RunJavaInteropTests">
    <MSBuild
        Condition=" '$(HostOS)' == 'Windows' "
        Projects="$(JavaInteropSourceDirectory)\Java.Interop.sln"
        Properties="_IsRestoring=true"
        Targets="Restore"
    />
    <MSBuild
        Condition=" '$(HostOS)' == 'Windows' "
        ContinueOnError="ErrorAndContinue"
        Projects="$(JavaInteropSourceDirectory)\Java.Interop.sln"
    />
    <Exec
        Command ="make -C &quot;$(JavaInteropSourceDirectory)&quot; CONFIGURATION=$(Configuration) all"
        Condition=" '$(HostOS)' != 'Windows' "
    />
    <SetEnvironmentVariable Name="ANDROID_SDK_PATH" Value="$(AndroidSdkFullPath)" />
    <MSBuild 
        ContinueOnError="ErrorAndContinue"
        Projects="$(JavaInteropSourceDirectory)\build-tools\scripts\RunNUnitTests.targets"
        Properties="AndroidSdkDirectory=$(AndroidSdkDirectory)"
    />
    <ItemGroup>
      <_RenameJITestCasesGlob Include="$(JavaInteropSourceDirectory)\TestResult-*Tests.xml" />
    </ItemGroup>
    <PropertyGroup>
      <_RenamedTestCases>@(_RenameJITestCasesGlob)</_RenamedTestCases>
    </PropertyGroup>
    <MSBuild
        ContinueOnError="ErrorAndContinue"
        Projects="$(MSBuildThisFileDirectory)TestApks.targets"
        Targets="RenameTestCases"
        Properties="Configuration=$(Configuration);RenameTestCasesGlob=$(_RenamedTestCases);BootstrapTasksAssembly=$(BootstrapTasksAssembly);PrepTasksAssembly=$(PrepTasksAssembly)"
    />
    <ItemGroup>
      <_JavaInteropTestResults Include="$(JavaInteropSourceDirectory)\TestResult-*.xml" />
    </ItemGroup>
    <Copy SourceFiles="@(_JavaInteropTestResults)" DestinationFolder="$(_TopDir)" />
    <Delete Files="@(_JavaInteropTestResults)" />
  </Target>

  <!-- Include the xaprepare-generated RunApkTests target -->
  <Import Project="$(_TopDir)\bin\Test$(Configuration)\RunTests.RunApkTests.proj" />

  <Target Name="RunPerformanceTests">
    <MSBuild Projects="$(MSBuildThisFileDirectory)..\timing\timing.csproj" Targets="MSBuildTiming" />
  </Target>
  <Target Name="RunNUnitDeviceTests">
    <MSBuild
        ContinueOnError="ErrorAndContinue"
        Projects="$(_TopDir)\tests\RunApkTests.targets"
        Targets="RunNUnitDeviceTests"
    />
  </Target>
  <ItemGroup>
    <_RunParallelTestTarget Include="RunNUnitTests" />
    <_RunParallelTestTarget Include="RunApkTests" />
  </ItemGroup>
  <ItemGroup>
    <_RunTestTarget Include="RunJavaInteropTests">
      <Properties></Properties>
    </_RunTestTarget>
    <_RunTestTarget Include="RunPerformanceTests">
      <Properties></Properties>
    </_RunTestTarget>
    <_RunTestTarget Include="RunApkTests">
      <Properties>RunApkTestsTarget=RunPerformanceApkTests</Properties>
    </_RunTestTarget>
    <_RunTestTarget Include="RunNUnitDeviceTests">
      <Properties></Properties>
    </_RunTestTarget>
  </ItemGroup>
  <Target Name="RunAllTests">
    <MSBuild
         ContinueOnError="ErrorAndContinue"
         Projects="$(MSBuildThisFileDirectory)RunTests.targets"
         RunEachTargetSeparately="True"
         Targets="@(_RunTestTarget)"
         Properties="%(_RunTestTarget.Properties)"
     />
    <RunParallelTargets
        ContinueOnError="ErrorAndContinue"
        Configuration="$(Configuration)"
        MSBuildBinaryLogParameterPrefix="$(_XABinLogPrefix)"
        MSBuildBinPath="$(MSBuildBinPath)"
        ProjectFile="$(MSBuildThisFileDirectory)RunTests.targets"
        Targets="@(_RunParallelTestTarget)"
    />
   </Target>
</Project>
