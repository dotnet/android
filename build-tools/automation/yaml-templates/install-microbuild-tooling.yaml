parameters:
  condition: succeeded()

steps:
- task: NuGetAuthenticate@1
  displayName: authenticate with azure artifacts
  inputs:
    forceReinstallCredentialProvider: true
  condition: ${{ parameters.condition }}

- task: UsePythonVersion@0
  inputs:
    versionSpec: 3.11

# ESRP signing requires minimum azure client version 2.8.0
- template: azure-tools/az-client-update.yml@yaml-templates
  parameters:
    version: '2.8.0'
    condition: and(${{ parameters.condition }}, eq(variables['agent.os'], 'Darwin'))

- pwsh: |
    Write-Host "=== Environment Variable Analysis ==="
    $vars = [Environment]::GetEnvironmentVariables()
    $totalSize = 0
    $varList = $vars.Keys | ForEach-Object {
      $size = $_.Length + $vars[$_].Length + 2  # +2 for = and null terminator
      $totalSize += $size
      [PSCustomObject]@{
        Name = $_
        ValueLength = $vars[$_].Length
        TotalSize = $size
      }
    } | Sort-Object TotalSize -Descending
    
    Write-Host "`nTop 50 largest environment variables:"
    $varList | Select-Object -First 50 | Format-Table -AutoSize
    
    Write-Host "`nTotal environment block size: $totalSize bytes"
    Write-Host "Windows limit: 65535 bytes"
    Write-Host "Over limit by: $($totalSize - 65535) bytes"
  displayName: Debug - Analyze environment variables before signing
  condition: ${{ parameters.condition }}

- task: MicroBuildSigningPlugin@4
  displayName: install signing plugin
  condition: ${{ parameters.condition }}
  inputs:
    ${{ if and(startsWith(variables['Build.SourceBranch'], 'refs/heads/release/'), ne(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.DefinitionName'], 'Xamarin.Android')) }}:
      signType: Real
    ${{ else }}:
      signType: Test
    azureSubscription: MicroBuild Signing Task (DevDiv)
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
