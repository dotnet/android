# Shared Linux build steps for both public and private pipelines
# This template contains the actual build logic without references to private repos

parameters:
  buildResultArtifactName: Build Results - Linux
  xaSourcePath: $(System.DefaultWorkingDirectory)/android
  nugetArtifactName: $(LinuxNuGetArtifactName)
  use1ESTemplate: true

steps:
- template: /build-tools/automation/yaml-templates/log-disk-space.yaml

- template: /build-tools/automation/yaml-templates/setup-jdk-variables.yaml
  parameters:
    useAgentJdkPath: false
    jdkMajorVersion: $(LatestJavaSdkMajorVersion)

- template: /build-tools/automation/yaml-templates/use-dot-net.yaml
  parameters:
    remove_dotnet: true

- task: NuGetAuthenticate@1
  displayName: authenticate with azure artifacts
  inputs:
    forceReinstallCredentialProvider: true

- template: /build-tools/automation/yaml-templates/log-disk-space.yaml

- script: make jenkins PREPARE_CI=1 PREPARE_AUTOPROVISION=1 CONFIGURATION=$(XA.Build.Configuration)
  workingDirectory: ${{ parameters.xaSourcePath }}
  displayName: make jenkins

- script: make create-nupkgs CONFIGURATION=$(XA.Build.Configuration)
  workingDirectory: ${{ parameters.xaSourcePath }}
  displayName: make create-nupkgs

- template: /build-tools/automation/yaml-templates/log-disk-space.yaml

- task: CopyFiles@2
  inputs:
    SourceFolder: ${{ parameters.xaSourcePath }}/bin/Build$(XA.Build.Configuration)/nuget-unsigned
    Contents: |
      **/Microsoft.Android.Sdk.Linux*.symbols.nupkg
      **/SignList.xml
    TargetFolder: ${{ parameters.xaSourcePath }}/bin/Build$(XA.Build.Configuration)/nuget-linux-symbols

- task: DeleteFiles@1
  inputs:
    SourceFolder: ${{ parameters.xaSourcePath }}/bin/Build$(XA.Build.Configuration)/nuget-unsigned
    Contents: '*.symbols.nupkg'

- script: >
    df -h &&
    mkdir -p ${{ parameters.xaSourcePath }}/bin/Build$(XA.Build.Configuration)/nuget-linux &&
    ln ${{ parameters.xaSourcePath }}/bin/Build$(XA.Build.Configuration)/nuget-unsigned/Microsoft.Android.Sdk.Linux*.nupkg
    ${{ parameters.xaSourcePath }}/bin/Build$(XA.Build.Configuration)/nuget-linux &&
    ln ${{ parameters.xaSourcePath }}/bin/Build$(XA.Build.Configuration)/nuget-unsigned/SignList.xml
    ${{ parameters.xaSourcePath }}/bin/Build$(XA.Build.Configuration)/nuget-linux
  workingDirectory: ${{ parameters.xaSourcePath }}
  displayName: copy linux sdk

- ${{ if ne(parameters.use1ESTemplate, true) }}:
  - task: PublishPipelineArtifact@1
    displayName: upload linux sdk
    inputs:
      artifactName: ${{ parameters.nugetArtifactName }}
      targetPath: ${{ parameters.xaSourcePath }}/bin/Build$(XA.Build.Configuration)/nuget-linux

  - task: PublishPipelineArtifact@1
    displayName: upload linux sdk symbols
    inputs:
      artifactName: ${{ parameters.nugetArtifactName }}-symbols
      targetPath: ${{ parameters.xaSourcePath }}/bin/Build$(XA.Build.Configuration)/nuget-linux-symbols

- template: /build-tools/automation/yaml-templates/upload-results.yaml
  parameters:
    xaSourcePath: ${{ parameters.xaSourcePath }}
    artifactName: ${{ parameters.buildResultArtifactName }}
    includeBuildResults: true
    use1ESTemplate: ${{ parameters.use1ESTemplate }}

- template: /build-tools/automation/yaml-templates/fail-on-dirty-tree.yaml
  parameters:
    xaSourcePath: ${{ parameters.xaSourcePath }}

- template: /build-tools/automation/yaml-templates/fail-on-issue.yaml
