parameters:
  testOS: ''              # 'macOS' or 'Windows'
  jobName: ''             # Name of the job
  jobDisplayName: ''      # Display name of the job
  agentCount: 1           # Number of build agents to run in parallel
  testFilter: ''          # Filter used to select tests (NUnit test selection language, not dotnet test filter language)
  xaSourcePath: $(System.DefaultWorkingDirectory)
  repositoryAlias: 'self'
  commit: ''
  shouldFailOnIssue: true

jobs:
- job: ${{ parameters.jobName }}
  strategy:
    parallel: ${{ parameters.agentCount }}
  displayName: ${{ parameters.jobDisplayName }}
  ${{ if eq(parameters.testOS, 'Windows') }}:
    pool: $(1ESWindowsPool)
  ${{ if eq(parameters.testOS, 'macOS') }}:
    pool:
      vmImage: $(HostedMacImage)
  timeoutInMinutes: 180
  cancelTimeoutInMinutes: 5
  steps:
  - ${{ if eq(parameters.testOS, 'Windows') }}:
    - script: netsh int ipv4 set global sourceroutingbehavior=drop

    - template: kill-processes.yaml@self

    - template: clean.yaml@self

  - template: setup-test-environment.yaml@self
    parameters:
      installTestSlicer: true
      installLegacyXamarinAndroid: true
      xaSourcePath: ${{ parameters.xaSourcePath }}
      repositoryAlias: ${{ parameters.repositoryAlias }}
      commit: ${{ parameters.commit }}

  - task: DownloadPipelineArtifact@2
    inputs:
      artifactName: $(TestAssembliesArtifactName)
      downloadPath: ${{ parameters.xaSourcePath }}/bin/Test$(XA.Build.Configuration)

  - template: run-sliced-nunit-tests.yaml@self
    parameters:
      testAssembly: ${{ parameters.xaSourcePath }}/bin/Test$(XA.Build.Configuration)/$(DotNetStableTargetFramework)/Xamarin.Android.Build.Tests.dll
      testFilter: ${{ parameters.testFilter }}
      testRunTitle: Xamarin.Android.Build.Tests - ${{ parameters.testOS }}
      retryFailedTests: false
      xaSourcePath: ${{ parameters.xaSourcePath }}

  - template: upload-results.yaml@self
    parameters:
      artifactName: Test Results - MSBuild - ${{ parameters.testOS }}-$(System.JobPositionInPhase)
      xaSourcePath: ${{ parameters.xaSourcePath }}

  - template: fail-on-issue.yaml@self
    parameters:
      condition: ${{ parameters.shouldFailOnIssue }}
