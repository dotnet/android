# Test Plan: New TypeMap Attribute-based Implementation

## Overview
The new typemap uses .NET 10's Type Mapping API with `[TypeMapAttribute]` and `[TypeMapAssociationAttribute]` to replace the legacy native typemap lookup. It's generated by `GenerateTypeMapAttributesStep` during ILLink and consumed at runtime by `TypeMapAttributeTypeMap`.

## Prerequisites
1. Build completed successfully: `make all`
2. Android device or emulator connected (`adb devices` shows a device)
3. Prepare the sample: `./dotnet-local.sh build samples/HelloWorld/HelloWorld/HelloWorld.DotNet.csproj -t:GenerateNuGetConfig`

---

## Test 1: Basic Build & Run (Release + CoreCLR)
```bash
# Build and deploy to device
./dotnet-local.sh build samples/HelloWorld/HelloWorld/HelloWorld.DotNet.csproj \
    -c Release \
    -t:Install \
    -p:EmbedAssembliesIntoApk=true \
    -bl:helloworld-release.binlog

# Run on device
adb shell am start -n example/.MainActivity
```
**Expected:** App launches, shows "HelloWorld" button that increments on click.

---

## Test 2: NativeAOT Build (new typemap is required)
```bash
./dotnet-local.sh publish samples/HelloWorld/HelloWorld/HelloWorld.DotNet.csproj \
    -c Release \
    -p:PublishAot=true \
    -p:AndroidRuntime=NativeAOT \
    -bl:helloworld-nativeaot.binlog

# Install and run
adb install -r samples/HelloWorld/HelloWorld/bin/Release/net11.0-android/android-arm64/publish/*.apk
adb shell am start -n example/.MainActivity
```
**Expected:** App launches and works identically to CoreCLR build.

---

## Test 3: Verify TypeMap Attributes Generated
After a Release build, inspect the trimmed assemblies:
```bash
# Check if TypeMapAttribute is present
./dotnet-local.sh tool run ilspycmd \
    samples/HelloWorld/HelloWorld/bin/Release/net11.0-android/linked/Mono.Android.dll \
    | grep -A5 "TypeMapAttribute"
```
**Expected:** Assembly-level `[TypeMapAttribute]` entries for Java types.

---

## Test 4: Verify Type Resolution at Runtime
Add logging to verify typemap works:
```csharp
// In MainActivity.OnCreate, add:
var javaType = Java.Lang.Class.ForName("android.widget.Button");
var managedType = JNIEnv.GetManagedType(javaType.Handle);
Android.Util.Log.Info("TypeMap", $"Button resolved to: {managedType?.FullName}");
```
**Expected:** LogCat shows `Button resolved to: Android.Widget.Button`

---

## Test 5: Custom Java Callable Wrapper
Test that user-defined JCWs (like `MainActivity`) work:
```bash
# Check adb logcat for any TypeManager errors
adb logcat -s mono-rt:* AndroidRuntime:* TypeMap:*
```
**Expected:** No errors related to type lookup or instance creation.

---

## Test 6: Binlog Analysis
Verify the `GenerateTypeMapAttributesStep` ran:
```bash
# Open binlog in MSBuild Structured Log Viewer
open helloworld-release.binlog
# Search for "GenerateTypeMapAttributesStep"
```
**Expected:** Step executed successfully, generated attributes visible in output.

---

## Test 7: Interface/Abstract Type Resolution (Invoker types)
Create a test that uses an interface callback:
```csharp
button.SetOnClickListener(new MyClickListener());

class MyClickListener : Java.Lang.Object, Android.Views.View.IOnClickListener
{
    public void OnClick(Android.Views.View v) => Console.WriteLine("Clicked!");
}
```
**Expected:** Callback works; invoker type `IOnClickListenerInvoker` resolved correctly.

---

## Quick Smoke Test Command
```bash
# One-liner to build, install, and run
./dotnet-local.sh build samples/HelloWorld/HelloWorld/HelloWorld.DotNet.csproj \
    -c Release -t:Run -p:EmbedAssembliesIntoApk=true -bl:test.binlog && \
    adb logcat -d | grep -E "TypeMap|Exception|Error" | tail -20
```

---

## Debugging Tips
- **Binlog:** Use `MSBuild Structured Log Viewer` to inspect build
- **ILSpy:** Decompile trimmed assemblies to verify attributes
- **ADB Logcat:** `adb logcat -s mono-rt:* | grep -i type`
- **Set env:** `adb shell setprop debug.mono.log default,assembly` for verbose runtime logs
